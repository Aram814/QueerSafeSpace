<!DOCTYPE-html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QueerSafeSpace</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#94a3b8',
                        background: '#f1f5f9',
                        text: '#1e293b',
                        white: '#ffffff',
                        red: '#ef4444',
                        green: '#22c5e',
                        yellow: '#facc15',
                        signin: '#8F7FFF',
                        signup: '#8EFD17',
                    }
                }
            }
        }
    </script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        xintegrity="sha512-iecdLp/Xq/C7xP5Kj8T6hE3p78+kC/K7p+g1k6Qf6d2G9w9a7a9g5tS5K3X/9z7aG6wD9wG8wF2e6y"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Global CSS Variables */
        :root {
            --primary: #6366f1;
            --secondary: #94a3b8;
            --background: #f1f5f9;
            --text: #1e293b;
            --white: #ffffff;
            --red: #ef4444;
            --green: #22c5e;
            --yellow: #facc15;
            --find-space-blue: #1272EF; /* Added new color variable */
        }

        /* Base Body and Container Styles */
        body {
            font-family: 'Inter', sans-serif;
            color: var(--text);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            background: linear-gradient(
                to right,
                rgba(255, 0, 0, 0.55),
                rgba(255, 144, 7, 0.55),
                rgba(251, 255, 0, 0.55),
                rgba(0, 250, 0, 0.55),
                rgba(0, 255, 238, 0.55),
                rgba(21, 0, 255, 0.55),
                rgba(106, 0, 255, 0.55),
                rgba(255, 0, 183, 0.55)
            );
        }

        /* Screen Transitions and Layouts */
        .screen {
            display: none;
            position: absolute; /* Changed to absolute to stack them */
            top: 0;
            left: 0;
            width: 100%;
            min-height: 100vh;
            overflow-y: auto;
            animation: fadeIn 0.5s ease-in-out;
            z-index: 10;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }
        
        /* Unique Backgrounds for Each Page */
        .screen::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.55;
            z-index: 1; /* Ensure background is behind content */
        }
        
        #map {
            width: 100%;
            height: 100%;
        }

        /* Frosted Glass Card Effect */
        .content-card {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            z-index: 2; /* Ensure card content is above background */
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .modal-content-with-close {
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
        }
        /* Floating Action Buttons */
        #fab {
            position: absolute;
            bottom: 2rem;
            left: 2rem;
            width: 60px;
            height: 60px;
            background-color: rgb(138, 63, 252);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }

        #fab:active {
            transform: scale(0.95);
        }

        #crisis-button {
            padding: 0.75rem 1.5rem;
            background-color: var(--red);
            color: var(--white);
            border-radius: 9999px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
            font-weight: 600;
        }

        #crisis-button:active {
            transform: scale(0.95);
        }
        
        /* Landing Page Specifics */
        .landing-logo {
            width: 200px;
            height: auto;
            margin-bottom: 2rem;
        }

        /* Side Menu and Toggle */
        #hamburger-menu-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 20;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 0.75rem;
            border-radius: 9999px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #side-menu {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 900;
        }

        #side-menu.open {
            transform: translateX(0);
        }

        #side-menu .menu-content {
            width: 75%;
            max-width: 300px;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 2rem;
            box-shadow: 4px 0 8px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }
        
        #side-menu a {
            padding: 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }

        #side-menu a:hover {
            background-color: var(--background);
        }

        /* Custom Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #80FD91;
        }

        input:checked+.slider:before {
            transform: translateX(22px);
        }

        #map-container {
            flex-grow: 1;
            position: relative;
            padding: 4px;
        }

        /* Map key styling */
        .map-key-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            font-size: 0.8rem;
            color: #6b7280;
            text-align: center;
        }

        .map-key-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .color-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Content pages styling */
        .content-container {
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
            text-align: left;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .content-container h2 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        .content-container h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .content-container p, .content-container ul {
            margin-bottom: 1rem;
            color: #4b5563;
        }
        .content-container strong {
            font-weight: bold;
        }

        /* Main Screen Specifics */
        #main-screen {
            position: relative; /* Set to relative for positioning children */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100vh;
        }

        #main-screen .top-controls {
            z-index: 30; /* Ensure this is on top of the map */
            position: relative;
            background-color: rgba(255, 255, 255, 0.5); /* Use a semi-transparent background */
        }

        #main-screen .bottom-controls {
            z-index: 30; /* Ensure this is on top of the map */
            position: relative;
            background-color: rgba(255, 255, 255, 0.5); /* Use a semi-transparent background */
        }
        
        .avatar-container {
            background-color: rgba(243, 244, 246, 0.8);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .avatar-selection-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
        }
        
        .avatar-option {
            font-size: 2rem;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s, transform 0.2s;
            text-align: center;
            padding: 4px;
            border-radius: 50%;
        }
        
        .avatar-option:hover {
            transform: scale(1.1);
            opacity: 1;
        }
        
        .avatar-option.selected {
            opacity: 1;
            border: 2px solid var(--primary);
            border-radius: 50%;
            transform: scale(1.1);
        }

        .form-message {
            margin-top: 1rem;
            text-align: center;
            font-size: 0.875rem;
        }

        /* Add this for the avatar in the menu */
        .menu-avatar {
            font-size: 2.5rem;
            margin-right: 0.5rem;
            display: inline-block;
            transition: transform 0.2s ease;
        }
    </style>
    <!-- Google Maps API script -->
    <!-- Replace 'YOUR_API_KEY' with your actual API key -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD1CzCfikz8oJVPe50hrHLNz2VKnN4rjMc"></script>
</head>

<body>
    <div id="app-container">
        <!-- Splash Screen -->
        <div id="splash-screen" class="screen active p-8 flex flex-col items-center justify-start pt-20">
            <div class="content-card w-full max-w-xl flex flex-col items-center">
                <img src="https://raw.githubusercontent.com/Aram814/QueerSafeSpace/refs/heads/main/IMG_9650.PNG"
                    alt="QueerSafeSpace Logo" class="landing-logo">
                <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-center">QueerSafeSpace</h1>
                <p class="text-gray-500 text-lg mt-2 text-center">Because Safety Shouldn’t Be A Privilege</p>
                <p class="text-sm text-center text-gray-700 mt-4 max-w-sm">QueerSafeSpace is a community-driven app for the LGBTQ+ community to find and share safe, inclusive spaces. This is not a dating or social networking app. Your contributions are anonymous, fostering a truly safe and supportive environment.</p>
                <div class="mt-8 w-full flex flex-col gap-4">
                    <button id="sign-in-btn"
                        class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 w-full" style="background-color: #8F7FFF; color: white;">Sign
                        in</button>
                    <button id="sign-up-btn"
                        class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 w-full" style="background-color: #8EFD17; color: white;">Sign
                        up</button>
                    <p class="text-sm text-gray-500 mt-2 text-center">The app is fully anonymous to protect all users.
                        However, without an account, saved data is limited resulting in limited features.</p>
                </div>
            </div>
        </div>

        <!-- Main App Screen (Map) -->
        <div id="main-screen" class="screen flex-col">
            <!-- Top Controls -->
            <div class="top-controls w-full flex flex-col items-center">
                <button id="hamburger-menu-btn" class="text-primary text-xl" aria-label="Open side menu">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <!-- Logo and App Name -->
                <div class="flex items-center justify-center p-4">
                    <img src="https://raw.githubusercontent.com/Aram814/QueerSafeSpace/refs/heads/main/IMG_9650.PNG"
                        alt="QueerSafeSpace Logo" class="h-10 w-10 mr-2">
                    <h1 class="text-2xl font-bold">QueerSafeSpace</h1>
                </div>

                <!-- Search and Filter Container -->
                <div class="flex w-full px-4 max-w-xl mx-auto space-x-2">
                    <div id="search-container" class="relative flex-grow shadow-md rounded-full overflow-hidden">
                        <label for="search-input" class="sr-only">Search</label>
                        <input type="text" id="search-input" placeholder="Search for safe spaces..."
                            class="w-full px-6 py-3 rounded-full border-2 border-transparent focus:outline-none focus:border-primary transition-colors">
                        <i class="fas fa-search absolute right-6 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button id="filter-btn" class="p-3 rounded-full bg-white shadow-md text-primary">
                        <i class="fa-solid fa-filter"></i>
                    </button>
                </div>
            </div>

            <!-- Map Container -->
            <div id="map-container" class="flex-grow p-4">
                <div id="map" class="w-full h-full rounded-xl shadow-lg border-2 border-gray-200"></div>
                <button id="fab" aria-label="Add a new safe space">
                    <i class="fa-solid fa-plus text-2xl"></i>
                </button>
            </div>

            <!-- Bottom Controls -->
            <div class="bottom-controls w-full">
                <!-- Map Key -->
                <div class="w-full py-2 map-key-container">
                    <div class="map-key-item">
                        <div class="color-dot" style="background-color: #19CA2E;"></div>
                        <span>Safe</span>
                    </div>
                    <div class="map-key-item">
                        <div class="color-dot" style="background-color: #F3F318;"></div>
                        <span>Mixed</span>
                    </div>
                    <div class="map-key-item">
                        <div class="color-dot" style="background-color: #FF0000;"></div>
                        <span>Not Safe</span>
                    </div>
                    <div class="map-key-item">
                        <div class="color-dot" style="background-color: #D9D9D9;"></div>
                        <span>Unknown</span>
                    </div>
                </div>

                <!-- Action Buttons below map -->
                <div class="flex justify-between w-full p-4">
                    <button id="find-safe-space-btn" class="px-6 py-3 rounded-full font-semibold text-white transition-all duration-300 transform hover:scale-105" style="background-color: #1272EF;">
                        Find My Safe Space
                    </button>
                    <button id="crisis-button" class="px-6 py-3 rounded-full font-semibold text-white transition-all duration-300 transform hover:scale-105 bg-red">
                        Crisis Button
                    </button>
                </div>
            </div>
        </div>

        <!-- Account Settings Screen (Placeholder) -->
        <div id="account-settings-screen" class="screen justify-start items-center p-8">
            <div class="content-card w-full max-w-xl">
                <h2 class="text-2xl font-bold mb-4 text-center">Account Settings</h2>
                
                <h3 class="text-lg font-bold mb-2">Change Avatar</h3>
                <div class="flex flex-col items-center mb-4">
                    <span id="current-avatar" class="text-6xl mb-4">🏳️‍🌈</span>
                    <div class="avatar-container">
                        <div id="avatar-selection-grid" class="avatar-selection-grid">
                            <span class="avatar-option" data-avatar="🏳️‍🌈">🏳️‍🌈</span>
                            <span class="avatar-option" data-avatar="🏳️‍⚧️">🏳️‍⚧️</span>
                            <span class="avatar-option" data-avatar="👩">👩</span>
                            <span class="avatar-option" data-avatar="👨">👨</span>
                            <span class="avatar-option" data-avatar="🧑">🧑</span>
                            <span class="avatar-option" data-avatar="❤️">❤️</span>
                            <span class="avatar-option" data-avatar="🧡">🧡</span>
                            <span class="avatar-option" data-avatar="💛">💛</span>
                            <span class="avatar-option" data-avatar="💚">💚</span>
                            <span class="avatar-option" data-avatar="💙">💙</span>
                            <span class="avatar-option" data-avatar="💜">💜</span>
                            <span class="avatar-option" data-avatar="🩵">🩵</span>
                            <span class="avatar-option" data-avatar="🩷">🩷</span>
                            <span class="avatar-option" data-avatar="🤍">🤍</span>
                            <span class="avatar-option" data-avatar="🖤">🖤</span>
                        </div>
                    </div>
                </div>
                
                <h3 class="text-lg font-bold mb-2">Change Username</h3>
                <form id="username-form" class="space-y-4 mb-8">
                    <div>
                        <label for="new-username" class="block text-sm font-medium text-gray-700">Username</label>
                        <input type="text" id="new-username"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary"
                            placeholder="Your new username">
                    </div>
                    <div id="username-message" class="form-message hidden"></div>
                    <button type="submit"
                        class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        Update Username
                    </button>
                </form>

                <h3 class="text-lg font-bold mb-2">Change Email</h3>
                <form id="email-form" class="space-y-4 mb-8">
                    <div>
                        <label for="new-email" class="block text-sm font-medium text-gray-700">New Email</label>
                        <input type="email" id="new-email"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary"
                            placeholder="your-new-email@example.com">
                    </div>
                    <div>
                        <label for="confirm-email" class="block text-sm font-medium text-gray-700">Confirm Email</label>
                        <input type="email" id="confirm-email"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary"
                            placeholder="your-new-email@example.com">
                    </div>
                    <div id="email-message" class="form-message hidden"></div>
                    <button type="submit"
                        class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        Update Email
                    </button>
                </form>

                <h3 class="text-lg font-bold mb-2">Change Password</h3>
                <form id="password-form" class="space-y-4 mb-8">
                    <div>
                        <label for="current-password" class="block text-sm font-medium text-gray-700">Current Password</label>
                        <input type="password" id="current-password"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                    </div>
                    <div>
                        <label for="password-new" class="block text-sm font-medium text-gray-700">New Password</label>
                        <input type="password" id="password-new"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                        <p class="text-xs text-gray-500 mt-1">Minimum 8 characters.</p>
                    </div>
                    <div>
                        <label for="confirm-password-new" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                        <input type="password" id="confirm-password-new"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                    </div>
                    <div id="password-message" class="form-message hidden"></div>
                    <button type="submit"
                        class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        Update Password
                    </button>
                </form>

                <button id="back-to-map-btn" class="mt-8 px-6 py-3 rounded-full font-semibold bg-primary text-white w-full">Back to Map</button>
            </div>
        </div>

        <!-- Contact Us Screen (Placeholder) -->
        <div id="contact-us-screen" class="screen justify-center items-center p-8">
            <div class="content-card text-center">
                <h2 class="text-2xl font-bold mb-4">Contact Us</h2>
                <p class="text-gray-600 mb-4">
                    QueerSafeSpace is a community-driven project dedicated to providing a safer environment for LGBTQ+ individuals. We believe everyone deserves to feel secure and have access to supportive resources.
                </p>
                <div class="flex flex-col items-center space-y-2 mt-4">
                    <a href="mailto:queersafespace.lgbt@gmail.com" class="text-primary hover:underline"><i class="fa-solid fa-envelope mr-2"></i> QueerSafeSpace.lgbt@gmail.com</a>
                    <a href="https://www.instagram.com/queersafespace.lgbt?igsh=OHkxbzkxaWdxOGRu" class="text-primary hover:underline"><i class="fa-brands fa-instagram mr-2"></i> @QueerSafeSpace.LGBT</a>
                    <a href="https://www.threads.com/@queersafespace.lgbt?igshid=NTc4MTIwNjQ2YQ==" class="text-primary hover:underline"><i class="fa-brands fa-x-threads mr-2"></i> @QueerSafeSpace.LGBT</a>
                </div>
                <button id="close-contact-btn" class="mt-8 px-6 py-3 rounded-full font-semibold bg-primary text-white">Close</button>
            </div>
        </div>

        <!-- Privacy Policy Screen -->
        <div id="privacy-policy-screen" class="screen flex-col items-center p-8">
            <div class="content-card w-full max-w-xl text-left">
                <h2 class="text-center">Privacy Policy</h2>
                <div class="prose max-w-none text-gray-600 leading-relaxed">
                    <h3 class="text-2xl font-bold text-gray-800">Privacy Policy – QueerSafeSpace</h3>
                    <p class="text-sm text-gray-500 mt-0">Effective Date: September 13, 2025</p>

                    <p>QueerSafeSpace (“we,” “our,” “us”) respects your privacy and is committed to protecting it. This Privacy Policy explains how we collect, use, and safeguard your information when you use our website, mobile app, and related services (the “Services”).</p>

                    <h4 class="text-xl font-semibold text-gray-700 mt-6">1. Information We Collect</h4>
                    <p>We may collect the following types of information:</p>
                    <ul class="list-disc list-inside ml-4 space-y-2">
                        <li><strong>Account Information:</strong> Email address (when you create an account).</li>
                        <li><strong>Location Data:</strong> If you choose to enable location sharing, we may collect your approximate or precise location to show safe spaces near you.</li>
                        <li><strong>Usage Data:</strong> Basic information about how you interact with our Services.</li>
                    </ul>

                    <h4 class="text-xl font-semibold text-gray-700 mt-6">2. Optional Data Sharing</h4>
                    <p>You may opt out of providing your location or email and still use limited features of the Services.</p>
                    <p>Location data is only used to display map features and is not shared publicly with your personal information.</p>

                    <h4 class="text-xl font-semibold text-gray-700 mt-6">3. How We Use Your Information</h4>
                    <p>We use your information to:</p>
                    <ul class="list-disc list-inside ml-4 space-y-2">
                        <li>Provide and improve the Services.</li>
                        <li>Personalize your experience (e.g., show nearby safe spaces).</li>
                        <li>Communicate with you about updates or support.</li>
                        <li>Maintain security and prevent misuse.</li>
                    </ul>

                    <h4 class="text-xl font-semibold text-gray-700 mt-6">4. Third-Party Services</h4>
                    <p>We may use trusted third-party providers, including:</p>
                    <ul class="list-disc list-inside ml-4 space-y-2">
                        <li><strong>Supabase</strong> – for secure data storage and authentication.</li>
                        <li><strong>Google Maps API</strong> – for map functionality.</li>
                        <li><strong>GitHub</strong> - various types of Data as specified in the privacy policy of the service.</li>
                    </ul>
                    <p>These services may collect data as governed by their own privacy policies.</p>

                    <h4 class="text-xl font-semibold text-gray-700 mt-6">5. Data Protection</h4>
                    <p>We use reasonable security measures to protect your data. However, no system is completely secure, and we cannot guarantee absolute protection.</p>

                    <h4 class="text-xl font-semibold text-gray-700 mt-6">6. Children’s Privacy</h4>
                    <p>QueerSafeSpace is not intended for children under 13. We do not knowingly collect information from children.</p>

                    <h4 class="text-xl font-semibold text-gray-700 mt-6">7. Future Monetization</h4>
                    <p>Currently, QueerSafeSpace is free to use. In the future, we may introduce subscription-based features. This Privacy Policy will be updated to reflect any changes.</p>

                    <h4 class="text-xl font-semibold text-gray-700 mt-6">8. Your Rights</h4>
                    <p>Depending on your location, you may have rights to access, correct, or delete your personal information. Contact us at <a href="mailto:QueerSafeSpace.lgbt@gmail.com" class="text-indigo-600 hover:underline">QueerSafeSpace.lgbt@gmail.com</a> to make a request.</p>

                    <h4 class="text-xl font-semibold text-gray-700 mt-6">9. Changes to this Policy</h4>
                    <p>We may update this Privacy Policy as our Services evolve. Updates will be posted here with a new “Effective Date.”</p>

                    <h4 class="text-xl font-semibold text-gray-700 mt-6">10. Contact Us</h4>
                    <p>If you have any questions or concerns, email us at: <a href="mailto:QueerSafeSpace.lgbt@gmail.com" class="text-indigo-600 hover:underline">QueerSafeSpace.lgbt@gmail.com</a></p>
                    <p class="text-center text-sm text-gray-500 mt-8">&copy; 2025 QueerSafeSpace. All rights reserved.</p>
                </div>
                <div class="text-center mt-8">
                    <button class="px-6 py-3 rounded-full font-semibold bg-primary text-white" id="close-privacy-btn">Close</button>
                </div>
            </div>
        </div>


        <!-- Terms and Conditions Screen -->
        <div id="terms-conditions-screen" class="screen flex-col items-center p-8">
            <div class="content-card w-full max-w-xl text-left">
                <h2 class="text-center">Terms & Conditions</h2>
                <div class="prose max-w-none text-gray-600 leading-relaxed">
                    <h3 class="text-2xl font-bold text-gray-800">Terms & Conditions – QueerSafeSpace</h3>
                    <p class="text-sm text-gray-500 mt-0">Effective Date: September 13, 2025</p>
                    
                    <p>Welcome to QueerSafeSpace! These Terms & Conditions (“Terms”) govern your use of our website, mobile app, and related services (the “Services”). By using QueerSafeSpace, you agree to these Terms.</p>
                    
                    <h4 class="text-xl font-semibold text-gray-700 mt-6">1. Eligibility</h4>
                    <p>You must be at least 13 years old to use our Services.</p>
                    
                    <h4 class="text-xl font-semibold text-gray-700 mt-6">2. Purpose of the App</h4>
                    <p>QueerSafeSpace is a community-driven platform designed to provide a safer environment for LGBTQ+ individuals by allowing users to find and share information about inclusive spaces. This app is <strong>not</strong> a dating or social networking platform. Its sole purpose is to enhance safety and community awareness.</p>
                    
                    <h4 class="text-xl font-semibold text-gray-700 mt-6">3. Account Responsibility</h4>
                    <p>You are responsible for keeping your account information (including your email and password) secure. You agree not to share false or misleading information when using our Services.</p>
                    
                    <h4 class="text-xl font-semibold text-gray-700 mt-6">4. User Conduct</h4>
                    <p>You agree to use the app in a respectful and responsible manner. You will not:</p>
                    <ul class="list-disc list-inside ml-4 space-y-2">
                        <li>Post or submit any content that is hateful, discriminatory, harassing, or threatening.</li>
                        <li>Misrepresent your identity or the purpose of your contributions.</li>
                        <li>Share any personally identifiable information about yourself or others in public sections of the app.</li>
                        <li>Use the app for any illegal activities or to violate any laws.</li>
                    </ul>
                    <p>We reserve the right to remove content that violates our community guidelines.</p>
                    
                    <h4 class="text-xl font-semibold text-gray-700 mt-6">5. Anonymity and Content</p>
                    <p>All user contributions, including ratings, reviews, and comments, are completely anonymous. By submitting content, you grant QueerSafeSpace a non-exclusive, royalty-free, worldwide license to use, reproduce, and display your anonymous contributions to improve the app.</p>
                    
                    <h4 class="text-xl font-semibold text-gray-700 mt-6">6. Location Services</p>
                    <p>Location features are optional. If you enable location, the app may use it to display nearby safe spaces. Disabling location may limit some features.</p>
                    
                    <h4 class="text-xl font-semibold text-gray-700 mt-6">7. Intellectual Property</p>
                    <p>All content, logos, and features of QueerSafeSpace are owned by us unless otherwise noted. You may not copy, distribute, or modify them without permission.</p>
                    
                    <h4 class="text-xl font-semibold text-gray-700 mt-6">8. Third-Party Services</p>
                    <p>Our Services may use third-party tools (e.g., Google Maps, Supabase, Github). Your use of these services is also subject to their terms.</p>
                    
                    <h4 class="text-xl font-semibold text-gray-700 mt-6">9. Disclaimer of Liability</p>
                    <p>QueerSafeSpace is community-driven. We cannot guarantee the accuracy, safety, or reliability of user-submitted locations or reviews. Use the Services at your own discretion and judgment. QueerSafeSpace is not liable for any damages or harm arising from your use of the app or reliance on user-generated content.</p>
                    
                    <h4 class="text-xl font-semibold text-gray-700 mt-6">10. Future Paid Features</p>
                    <p>Currently, QueerSafeSpace is free. In the future, we may offer subscription-based or premium features. Details will be provided in updated Terms.</p>
                    
                    <h4 class="text-xl font-semibold text-gray-700 mt-6">11. Account Termination</p>
                    <p>We may suspend or terminate accounts that violate these Terms or harm the community.</p>
                    
                    <h4 class="text-xl font-semibold text-gray-700 mt-6">12. Changes to Terms</p>
                    <p>We may modify these terms at any time. If we make changes, we will post the updated terms on this page. Your continued use of the app after any changes constitutes your acceptance of the new terms.</p>
                    
                    <h4 class="text-xl font-semibold text-gray-700 mt-6">13. Governing Law</p>
                    <p>These Terms are governed by the laws of the State of Florida, United States.</p>
                    
                    <h4 class="text-xl font-semibold text-gray-700 mt-6">14. Contact Us</p>
                    <p>For questions about these Terms, contact us at: <a href="mailto:QueerSafeSpace.lgbt@gmail.com" class="text-primary hover:underline">QueerSafeSpace.lgbt@gmail.com</a></p>
    
                    <p class="text-center text-sm text-gray-500 mt-8">&copy; 2025 QueerSafeSpace. All rights reserved.</p>
    
                </div>

                <div class="text-center mt-8">
                    <button class="px-6 py-3 rounded-full font-semibold bg-primary text-white" id="close-terms-btn">Close</button>
                </div>
            </div>
        </div>


        <!-- Modals -->
        <div id="auth-modal" class="modal-overlay">
            <div class="modal-content">
                <h2 id="auth-title" class="text-2xl font-bold mb-4"></h2>
                <form id="auth-form" class="space-y-4">
                    <div>
                        <label for="auth-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="auth-email"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary"
                            placeholder="you@example.com">
                    </div>
                    <!-- Password and Confirm Password Fields -->
                    <div id="password-fields">
                        <div>
                            <label for="auth-password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="auth-password"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <p id="password-requirements-text" class="text-xs text-gray-500 mt-1 hidden">Password must be a minimum of 8 characters.</p>
                        </div>
                        <div id="confirm-password-container" class="mt-4 hidden">
                            <label for="auth-confirm-password" class="block text-sm font-medium text-gray-700">Confirm
                                Password</label>
                            <input type="password" id="auth-confirm-password"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                        </div>
                    </div>
                    <!-- Agreements for Sign Up -->
                    <div id="agreements-container" class="space-y-2 text-sm text-gray-400 hidden">
                        <div class="flex items-start">
                            <input type="checkbox" id="terms" name="terms"
                                class="mr-2 mt-1 rounded text-purple-600 focus:ring-purple-500">
                            <label for="terms" class="text-gray-700">I agree to the <a href="#" class="text-primary hover:underline" id="terms-link">Terms and Conditions</a></label>
                        </div>
                        <div class="flex items-start">
                            <input type="checkbox" id="privacy" name="privacy"
                                class="mr-2 mt-1 rounded text-purple-600 focus:ring-purple-500">
                            <label for="privacy" class="text-gray-700">I agree to the <a href="#" class="text-primary hover:underline" id="privacy-link">Privacy Policy</a></label>
                        </div>
                    </div>
                    <a href="#" id="forgot-password-link" class="text-sm text-primary hover:underline hidden">Forgot password?</a>
                    <button id="submit-auth-btn" type="submit"
                        class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        <span id="auth-button-text"></span>
                    </button>
                </form>
                <div id="auth-message" class="mt-4 text-center"></div>
                <button id="close-auth-modal"
                    class="mt-4 w-full text-sm text-gray-500 hover:text-gray-700">Cancel</button>
            </div>
        </div>

        <!-- Pop-up Modal -->
        <div id="coming-soon-modal" class="modal-overlay">
            <div class="modal-content modal-content-with-close">
                <button id="close-coming-soon-btn" class="modal-close-btn">&times;</button>
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Feature Coming Soon!</h2>
                <p class="text-gray-600 mb-4 text-center">This feature is currently under development. Thank you for your patience!</p>
            </div>
        </div>


        <!-- Sidebar Menu -->
        <div id="side-menu">
            <div class="menu-content flex flex-col p-8 bg-white">
                <button id="close-menu-btn" class="self-end text-2xl text-gray-500">&times;</button>
                <div class="flex items-center space-x-2 mb-6">
                    <span id="menu-avatar" class="text-4xl">🏳️‍🌈</span>
                    <h3 id="user-name" class="text-2xl font-bold">User Name</h3>
                </div>
                <a href="#" class="mb-2 text-gray-700 font-semibold" data-screen="account-settings-screen">
                    <i class="fa-solid fa-user-cog mr-2"></i> Account Settings
                </a>
                <div class="flex items-center justify-between mb-2 p-2 rounded-md hover:bg-gray-100 transition-colors">
                    <span class="text-gray-700 font-semibold">
                        <i class="fa-solid fa-shield-alt mr-2"></i> Crisis Mode Settings
                    </span>
                    <span class="text-xs text-gray-400 italic">Coming Soon</span>
                </div>
                <hr class="border-t border-gray-200 my-2">
                <a href="#" class="mb-2 text-gray-700 font-semibold" data-screen="contact-us-screen">
                    <i class="fa-solid fa-headset mr-2"></i> Contact Us!
                </a>
                <a href="#" class="mb-2 text-gray-700 font-semibold" data-screen="privacy-policy-screen">
                    <i class="fa-solid fa-lock mr-2"></i> Privacy Policy
                </a>
                <a href="#" class="mb-2 text-gray-700 font-semibold" data-screen="terms-conditions-screen">
                    <i class="fa-solid fa-file-contract mr-2"></i> Terms and Conditions
                </a>
                <div class="mt-auto">
                    <hr class="border-t-2 border-gray-200 my-4">
                    <button id="sign-out-btn" class="w-full text-left py-2 px-4 rounded-md text-gray-700 font-semibold">
                        <i class="fa-solid fa-right-from-bracket mr-2"></i> Log out
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- The main application script using type="module" -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.2/+esm';

        // --- Supabase Configuration & Initialization ---
        const supabaseUrl = 'https://sgvxsyvqluhivohypkkg.supabase.co';
        // IMPORTANT: Replace this placeholder with your actual Supabase Anon Key.
        // You can find it in your Supabase project settings under "API".
        // Never hardcode this in a production app; use environment variables instead.
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNndnhzeXZxbHVoaXZvaHlwa2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3MjYzNzIsImV4cCI6MjA3MzMwMjM3Mn0.igseAZIczG6fEdtPNuF3_xyXb3rFKh5nQxxO_YUyCEs';
        
        let supabase = null;

        // Ensure the key is not the placeholder before initializing the client.
        if (supabaseAnonKey === 'YOUR_SUPABASE_ANON_KEY' || !supabaseAnonKey) {
            console.error("Supabase API key is missing. Please replace the placeholder 'YOUR_SUPABASE_ANON_KEY' with your actual key.");
        } else {
            supabase = createClient(supabaseUrl, supabaseAnonKey);
            console.log("Supabase client created successfully.");
        }
        
        // --- Map Initialization ---
        let mapLoaded = false;
        let map = null;

        function initMap() {
            if (mapLoaded) return; // Prevent re-initializing the map

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        map = new google.maps.Map(document.getElementById('map'), {
                            center: userLocation,
                            zoom: 12,
                        });
                        mapLoaded = true;
                    },
                    () => {
                        // If geolocation fails, center the map on a default location
                        const defaultLocation = { lat: 28.74, lng: -82.49 }; // Central Florida, USA
                        map = new google.maps.Map(document.getElementById('map'), {
                            center: defaultLocation,
                            zoom: 10,
                        });
                        mapLoaded = true;
                    }
                );
            } else {
                // If the browser doesn't support geolocation, use a default location
                const defaultLocation = { lat: 28.74, lng: -82.49 }; // Central Florida, USA
                map = new google.maps.Map(document.getElementById('map'), {
                    center: defaultLocation,
                    zoom: 10,
                });
                mapLoaded = true;
            }
        }


        // --- DOM Elements ---
        const splashScreen = document.getElementById('splash-screen');
        const mainScreen = document.getElementById('main-screen');
        const accountSettingsScreen = document.getElementById('account-settings-screen');
        const contactUsScreen = document.getElementById('contact-us-screen');
        const privacyPolicyScreen = document.getElementById('privacy-policy-screen');
        const termsConditionsScreen = document.getElementById('terms-conditions-screen');
        const signInBtn = document.getElementById('sign-in-btn');
        const signUpBtn = document.getElementById('sign-up-btn');
        const authModal = document.getElementById('auth-modal');
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const authEmail = document.getElementById('auth-email');
        const authPassword = document.getElementById('auth-password');
        const authConfirmPassword = document.getElementById('auth-confirm-password');
        const authButtonText = document.getElementById('auth-button-text');
        const authMessage = document.getElementById('auth-message');
        const closeAuthModal = document.getElementById('close-auth-modal');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const confirmPasswordContainer = document.getElementById('confirm-password-container');
        const passwordFields = document.getElementById('password-fields');
        const passwordRequirementsText = document.getElementById('password-requirements-text');
        const agreementsContainer = document.getElementById('agreements-container');
        
        // --- DOM Elements for Menu ---
        const hamburgerMenuBtn = document.getElementById('hamburger-menu-btn');
        const sideMenu = document.getElementById('side-menu');
        const closeMenuBtn = document.getElementById('close-menu-btn');
        const menuLinks = sideMenu.querySelectorAll('a');
        const signOutBtn = document.getElementById('sign-out-btn');
        const userNameElement = document.getElementById('user-name');
        const termsCheckbox = document.getElementById('terms');
        const privacyCheckbox = document.getElementById('privacy');
        // New elements for modal navigation
        const termsLink = document.getElementById('terms-link');
        const privacyLink = document.getElementById('privacy-link');
        const closePrivacyBtn = document.getElementById('close-privacy-btn');
        const closeTermsBtn = document.getElementById('close-terms-btn');
        const backToMapBtn = document.getElementById('back-to-map-btn');
        const closeContactBtn = document.getElementById('close-contact-btn');
        const menuAvatar = document.getElementById('menu-avatar');

        // New elements for the "Coming Soon" pop-up
        const findSafeSpaceBtn = document.getElementById('find-safe-space-btn');
        const crisisButton = document.getElementById('crisis-button');
        const comingSoonModal = document.getElementById('coming-soon-modal');
        const closeComingSoonBtn = document.getElementById('close-coming-soon-btn');

        // --- Account Settings Screen DOM Elements ---
        const currentAvatarElement = document.getElementById('current-avatar');
        const avatarSelectionGrid = document.getElementById('avatar-selection-grid');
        const usernameForm = document.getElementById('username-form');
        const newUsernameInput = document.getElementById('new-username');
        const usernameMessage = document.getElementById('username-message');
        const emailForm = document.getElementById('email-form');
        const newEmailInput = document.getElementById('new-email');
        const confirmEmailInput = document.getElementById('confirm-email');
        const emailMessage = document.getElementById('email-message');
        const passwordForm = document.getElementById('password-form');
        const currentPasswordInput = document.getElementById('current-password');
        const newPasswordInput = document.getElementById('password-new');
        const confirmNewPasswordInput = document.getElementById('confirm-password-new');
        const passwordMessage = document.getElementById('password-message');


        let modalMode = 'signin';
        let previousScreenId = 'splash-screen'; // Track the previous screen for the close buttons
        let currentUserId = null;

        // --- Utility Functions ---
        function showScreen(screenId) {
            const currentActiveScreen = document.querySelector('.screen.active');
            if (currentActiveScreen) {
                previousScreenId = currentActiveScreen.id;
            }

            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active');
                screen.style.display = 'none';
            });
            
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                targetScreen.style.display = 'flex';
            }

            // If the map screen is being shown, initialize the map
            if (screenId === 'main-screen' && !mapLoaded) {
                if (window.google && window.google.maps) {
                    initMap();
                } else {
                    // Poll for the Google Maps API to be ready
                    const interval = setInterval(() => {
                        if (window.google && window.google.maps) {
                            initMap();
                            clearInterval(interval);
                        }
                    }, 200);
                }
            }
        }

        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function showMessage(element, message, type = 'info') {
            let color = 'text-gray-500';
            if (type === 'success') color = 'text-green-500';
            if (type === 'error') color = 'text-red-500';
            element.className = `mt-4 text-center ${color}`;
            element.textContent = message;
            element.classList.remove('hidden');
        }

        function setModalMode(mode) {
            modalMode = mode;
            authForm.reset();
            showMessage(authMessage, '', 'info');
            passwordFields.classList.add('hidden');
            forgotPasswordLink.classList.add('hidden');
            confirmPasswordContainer.classList.add('hidden');
            passwordRequirementsText.classList.add('hidden');
            agreementsContainer.classList.add('hidden');
            authEmail.disabled = false;
            authPassword.disabled = false;

            switch (mode) {
                case 'signin':
                    authTitle.textContent = 'Sign In';
                    authButtonText.textContent = 'Sign In';
                    passwordFields.classList.remove('hidden');
                    forgotPasswordLink.classList.remove('hidden');
                    break;
                case 'signup':
                    authTitle.textContent = 'Sign Up';
                    authButtonText.textContent = 'Sign Up';
                    passwordFields.classList.remove('hidden');
                    confirmPasswordContainer.classList.remove('hidden');
                    passwordRequirementsText.classList.remove('hidden');
                    agreementsContainer.classList.remove('hidden');
                    break;
                case 'forgotPassword':
                    authTitle.textContent = 'Reset Password';
                    authButtonText.textContent = 'Send Reset Link';
                    passwordFields.classList.add('hidden');
                    forgotPasswordLink.classList.add('hidden');
                    break;
            }
        }

        // --- Supabase Auth & Data Functions ---
        async function handleSignUp(email, password, confirmPassword) {
            if (!termsCheckbox.checked || !privacyCheckbox.checked) {
                showMessage(authMessage, 'You must agree to both the Terms and Conditions and the Privacy Policy.', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showMessage(authMessage, 'Passwords do not match. Please try again.', 'error');
                return;
            }

            if (password.length < 8) {
                showMessage(authMessage, 'Password must be a minimum of 8 characters.', 'error');
                return;
            }
            if(!supabase){
                showMessage(authMessage, "Supabase is not initialized. Please check your API key.", "error");
                return;
            }

            showMessage(authMessage, 'Signing up...');
            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                });

                if (error) {
                    throw error;
                }
                
                // Automatically create a profile for the new user
                await createProfile(data.user.id);
                
                console.log("Sign up successful:", data);
                showMessage(authMessage, 'Sign up successful! Please check your email to confirm.', 'success');
                hideModal('auth-modal');
                
                // Redirect to main screen after successful sign-up
                showScreen('main-screen');


            } catch (error) {
                showMessage(authMessage, `Sign up failed: ${error.message}`, 'error');
                console.error("Supabase Sign Up Error:", error.message);
            }
        }

        async function handleSignIn(email, password) {
            if(!supabase){
                showMessage(authMessage, "Supabase is not initialized. Please check your API key.", "error");
                return;
            }
            showMessage(authMessage, 'Signing in...');
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (error) {
                    throw error;
                }

                console.log("Sign in successful:", data);
                showMessage(authMessage, 'Signed in successfully!', 'success');
                hideModal('auth-modal');

            } catch (error) {
                showMessage(authMessage, `Sign in failed: ${error.message}`, 'error');
                console.error("Supabase Sign In Error:", error.message);
            }
        }

        async function handleForgotPassword(email) {
            if(!supabase){
                showMessage(authMessage, "Supabase is not initialized. Please check your API key.", "error");
                return;
            }
            showMessage(authMessage, 'Sending password reset link...');
            try {
                const { error } = await supabase.auth.resetPasswordForEmail(email);

                if (error) {
                    throw error;
                }

                showMessage(authMessage, 'Password reset link sent! Check your email.', 'success');
                authEmail.disabled = true;

            } catch (error) {
                showMessage(authMessage, `Failed to send reset link: ${error.message}`, 'error');
                console.error("Supabase Reset Password Error:", error.message);
            }
        }

        async function handleSignOut() {
            if(!supabase){
                showMessage(authMessage, "Supabase is not initialized. Please check your API key.", "error");
                return;
            }
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                console.log("Signed out successfully.");
                sideMenu.classList.remove('open');
                showScreen('splash-screen');
            } catch (error) {
                console.error("Supabase Sign Out Error:", error.message);
            }
        }
        
        async function createProfile(userId) {
            if (!supabase) return;
            const { data, error } = await supabase
                .from('profiles')
                .insert({ 
                    user_id: userId, 
                    username: 'New User', 
                    avatar_url: '🏳️‍🌈',
                });
            if (error) {
                console.error("Error creating profile:", error.message);
            } else {
                console.log("Profile created successfully:", data);
            }
        }

        async function fetchProfile(userId) {
            if (!supabase) return;
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('username, avatar_url')
                    .eq('user_id', userId)
                    .single();

                if (error) {
                    throw error;
                }
                
                userNameElement.textContent = data.username;
                currentAvatarElement.textContent = data.avatar_url;
                menuAvatar.textContent = data.avatar_url;
                newUsernameInput.value = data.username;
                
                // Set the correct avatar option as selected
                document.querySelectorAll('.avatar-option').forEach(option => {
                    if (option.dataset.avatar === data.avatar_url) {
                        option.classList.add('selected');
                    } else {
                        option.classList.remove('selected');
                    }
                });
                return data;

            } catch (error) {
                console.error("Error fetching profile:", error.message);
                if (error.code === 'PGRST116') {
                    // Profile not found, create one
                    await createProfile(userId);
                    return await fetchProfile(userId); // Re-fetch after creation
                }
            }
        }

        async function updateUsername(newUsername) {
            if (!supabase || !currentUserId) {
                showMessage(usernameMessage, "User not authenticated.", 'error');
                return;
            }
            showMessage(usernameMessage, 'Updating username...', 'info');
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .update({ username: newUsername })
                    .eq('user_id', currentUserId)
                    .select();

                if (error) {
                    throw error;
                }
                
                showMessage(usernameMessage, 'Username updated successfully!', 'success');
                userNameElement.textContent = data[0].username;

            } catch (error) {
                showMessage(usernameMessage, `Error: ${error.message}`, 'error');
                console.error("Error updating username:", error.message);
            }
        }
        
        async function updateAvatar(newAvatar) {
            if (!supabase || !currentUserId) return;
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .update({ avatar_url: newAvatar })
                    .eq('user_id', currentUserId)
                    .select();

                if (error) {
                    throw error;
                }
                
                currentAvatarElement.textContent = data[0].avatar_url;
                menuAvatar.textContent = data[0].avatar_url;

            } catch (error) {
                console.error("Error updating avatar:", error.message);
            }
        }

        async function updateEmail(newEmail) {
            if (!supabase || !currentUserId) {
                showMessage(emailMessage, "User not authenticated.", 'error');
                return;
            }
            showMessage(emailMessage, 'Updating email...', 'info');
            try {
                const { data, error } = await supabase.auth.updateUser({ email: newEmail });
                
                if (error) {
                    throw error;
                }
                
                showMessage(emailMessage, 'Email updated! Check your new email for a confirmation link.', 'success');
                emailForm.reset();

            } catch (error) {
                showMessage(emailMessage, `Error: ${error.message}`, 'error');
                console.error("Error updating email:", error.message);
            }
        }

        async function updatePassword(newPassword) {
            if (!supabase || !currentUserId) {
                showMessage(passwordMessage, "User not authenticated.", 'error');
                return;
            }
            showMessage(passwordMessage, 'Updating password...', 'info');
            try {
                const { data, error } = await supabase.auth.updateUser({ password: newPassword });
                
                if (error) {
                    throw error;
                }
                
                showMessage(passwordMessage, 'Password updated successfully!', 'success');
                passwordForm.reset();

            } catch (error) {
                showMessage(passwordMessage, `Error: ${error.message}`, 'error');
                console.error("Error updating password:", error.message);
            }
        }
        
        // --- Event Listeners ---
        window.addEventListener('DOMContentLoaded', () => {
            showScreen('splash-screen');

            // Handle user auth actions
            signInBtn.addEventListener('click', () => {
                setModalMode('signin');
                showModal('auth-modal');
            });

            signUpBtn.addEventListener('click', () => {
                setModalMode('signup');
                showModal('auth-modal');
            });

            closeAuthModal.addEventListener('click', () => {
                hideModal('auth-modal');
                setModalMode('signin');
            });

            forgotPasswordLink.addEventListener('click', (e) => {
                e.preventDefault();
                setModalMode('forgotPassword');
            });

            authForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = authEmail.value;
                const password = authPassword.value;
                const confirmPassword = authConfirmPassword.value;

                if (modalMode === 'signin') {
                    handleSignIn(email, password);
                } else if (modalMode === 'signup') {
                    handleSignUp(email, password, confirmPassword);
                } else if (modalMode === 'forgotPassword') {
                    handleForgotPassword(email);
                }
            });

            hamburgerMenuBtn.addEventListener('click', () => {
                sideMenu.classList.add('open');
            });

            closeMenuBtn.addEventListener('click', () => {
                sideMenu.classList.remove('open');
            });

            menuLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetScreenId = link.dataset.screen;
                    if (targetScreenId) {
                        showScreen(targetScreenId);
                    }
                    sideMenu.classList.remove('open');
                });
            });

            signOutBtn.addEventListener('click', () => {
                handleSignOut();
            });

            // Event listeners for links inside the sign-up modal
            termsLink.addEventListener('click', (e) => {
                e.preventDefault();
                hideModal('auth-modal');
                showScreen('terms-conditions-screen');
            });

            privacyLink.addEventListener('click', (e) => {
                e.preventDefault();
                hideModal('auth-modal');
                showScreen('privacy-policy-screen');
            });

            // Event listeners for back buttons on policy screens
            closePrivacyBtn.addEventListener('click', () => {
                showScreen(previousScreenId);
            });

            closeTermsBtn.addEventListener('click', () => {
                showScreen(previousScreenId);
            });
            
            backToMapBtn.addEventListener('click', () => {
                showScreen('main-screen');
            });

            closeContactBtn.addEventListener('click', () => {
                showScreen('main-screen');
            });

            findSafeSpaceBtn.addEventListener('click', () => {
                showModal('coming-soon-modal');
            });

            crisisButton.addEventListener('click', () => {
                showModal('coming-soon-modal');
            });

            closeComingSoonBtn.addEventListener('click', () => {
                hideModal('coming-soon-modal');
            });

            // --- New Account Settings Event Listeners ---
            avatarSelectionGrid.addEventListener('click', (e) => {
                const avatarOption = e.target.closest('.avatar-option');
                if (!avatarOption) return;

                const selectedAvatar = avatarOption.dataset.avatar;
                if (currentAvatarElement.textContent === selectedAvatar) return; // No change

                // Update UI
                document.querySelectorAll('.avatar-option').forEach(option => option.classList.remove('selected'));
                avatarOption.classList.add('selected');
                currentAvatarElement.textContent = selectedAvatar;
                menuAvatar.textContent = selectedAvatar;
                
                updateAvatar(selectedAvatar);
            });
            
            usernameForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newUsername = newUsernameInput.value;
                if (newUsername.trim() === '') {
                    showMessage(usernameMessage, 'Username cannot be empty.', 'error');
                    return;
                }
                updateUsername(newUsername);
            });
            
            emailForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newEmail = newEmailInput.value;
                const confirmEmail = confirmEmailInput.value;

                if (newEmail !== confirmEmail) {
                    showMessage(emailMessage, 'Emails do not match.', 'error');
                    return;
                }
                updateEmail(newEmail);
            });
            
            passwordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newPassword = newPasswordInput.value;
                const confirmNewPassword = confirmNewPasswordInput.value;
                
                // Supabase doesn't require the current password, but we can do a simple check
                // This will be replaced with a more secure re-authentication flow in a real app
                if (newPassword.length < 8) {
                    showMessage(passwordMessage, 'New password must be at least 8 characters long.', 'error');
                    return;
                }

                if (newPassword !== confirmNewPassword) {
                    showMessage(passwordMessage, 'New passwords do not match.', 'error');
                    return;
                }
                
                updatePassword(newPassword);
            });


            // Supabase session listener
            if(supabase){
                supabase.auth.onAuthStateChange(async (event, session) => {
                    console.log("Auth state change event:", event, "Session:", session);
                    if (session) {
                        currentUserId = session.user.id;
                        // Fetch the user's profile and proceed to the main screen
                        await fetchProfile(currentUserId);
                        showScreen('main-screen');
                    } else {
                        currentUserId = null;
                        userNameElement.textContent = "User Name";
                        currentAvatarElement.textContent = "🏳️‍🌈"; // Reset avatar
                        menuAvatar.textContent = "🏳️‍🌈";
                        showScreen('splash-screen');
                    }
                });
            }
        });
    </script>
</body>

</html>
