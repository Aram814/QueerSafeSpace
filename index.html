<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QueerSafeSpace</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#94a3b8',
                        background: '#f1f5f9',
                        text: '#1e293b',
                        white: '#ffffff',
                        red: '#ef4444',
                        green: '#22c59e',
                        yellow: '#facc15',
                        signin: '#FF6161',
                        signup: '#80FD91',
                    }
                }
            }
        }
    </script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        xintegrity="sha512-iecdLp/Xq/C7xP5Kj8T6hE3p78+kC/K7p+g1k6Qf6d2G9w9a7a9g5tS5K3X/9z7aG6wD9wG8wF2e6y"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #94a3b8;
            --background: #f1f5f9;
            --text: #1e293b;
            --white: #ffffff;
            --red: #ef4444;
            --green: #22c59e;
            --yellow: #facc15;
        }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--text);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #app-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .screen {
            display: none;
            flex-grow: 1;
            overflow: auto;
            animation: fadeIn 0.5s ease-in-out;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--white);
            z-index: 10;
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            opacity: 1;
        }

        .rainbow-bg {
            background: linear-gradient(135deg, rgba(255, 105, 180, 0.3), rgba(255, 255, 0, 0.3), rgba(0, 255, 0, 0.3), rgba(0, 191, 255, 0.3), rgba(138, 43, 226, 0.3));
        }

        #map-container {
            flex-grow: 1;
            width: 100%;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--white);
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 90vh;
            overflow-y: auto;
        }

        #fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background-color: rgb(138, 63, 252);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 50;
            transition: transform 0.2s ease-in-out;
        }

        #fab:active {
            transform: scale(0.95);
        }

        .landing-logo {
            width: 200px;
            height: auto;
            margin-bottom: 2rem;
        }

        .location-illustration {
            width: 80%;
            max-width: 300px;
            height: auto;
            margin-bottom: 2rem;
        }

        /* Permission Toggle Button Styles */
        .permission-toggle-btn {
            transition: background-color 0.2s, color 0.2s, transform 0.2s;
        }

        .permission-toggle-btn.active-toggle {
            background-color: var(--green) !important;
            color: var(--white) !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .permission-toggle-btn.active-toggle[data-permission-status="deny"] {
            background-color: var(--red) !important;
        }

        .permission-toggle-btn:hover {
            transform: translateY(-2px);
        }
    </style>
</head>

<body>
    <div id="app-container">
        <!-- Splash Screen -->
        <div id="splash-screen" class="screen active p-8 rainbow-bg flex flex-col items-center justify-start pt-20">
            <img src="https://raw.githubusercontent.com/Aram814/QueerSafeSpace/refs/heads/main/IMG_9650.PNG" alt="QueerSafeSpace Logo"
                class="landing-logo">
            <h1 class="text-4xl md:text-5xl font-bold mt-4">QueerSafeSpace</h1>
            <p class="text-gray-500 text-lg mt-2">Because Safety Shouldnâ€™t Be A Privilege</p>
            <div class="mt-8 w-full max-w-sm flex flex-col gap-4">
                <button id="sign-in-btn"
                    class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-signin text-white w-full">Sign
                    in</button>
                <button id="sign-up-btn"
                    class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-signup text-white w-full">Sign
                    up</button>
                <button id="anon-btn"
                    class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-transparent text-primary border-2 border-primary w-full">Continue
                    anonymously</button>
                <p class="text-sm text-gray-500 mt-2 text-center">The app is fully anonymous to protect all users. However, without an account, saved data is limited resulting in limited features.</p>
            </div>
        </div>

        <!-- Permissions Screen -->
        <div id="permissions-screen" class="screen flex-col items-center pt-10 p-8 text-center rainbow-bg overflow-y-auto">
            <div class="flex flex-col items-center p-6 md:p-10 rounded-xl">
                <h2 class="text-3xl font-bold mb-2">Your Privacy Matters.</h2>
                <p class="text-gray-500 mb-8 max-w-sm">To provide the best safety insights, we need your help.</p>

                <!-- Location Section -->
                <div class="permission-section w-full max-w-sm mb-6 text-left">
                    <h3 class="text-lg font-semibold text-text">Location</h3>
                    <p class="text-sm text-gray-500 mb-2">This is <strong>critical</strong> for the Safety Map and additional features. It helps us show you nearby safe/unsafe spaces and resources. Your location is <strong>never</strong> shared publicly.</p>
                    <div class="flex items-center gap-4 mt-2">
                        <button class="permission-toggle-btn active-toggle bg-green text-white px-4 py-2 rounded-full font-semibold" data-permission-type="location" data-permission-status="allow">Allow</button>
                        <button class="permission-toggle-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-full font-semibold" data-permission-type="location" data-permission-status="deny">Limited Features</button>
                    </div>
                </div>

                <!-- Notifications Section -->
                <div class="permission-section w-full max-w-sm mb-6 text-left">
                    <h3 class="text-lg font-semibold text-text">Notifications</h3>
                    <p class="text-sm text-gray-500 mb-2">Receive important safety alerts, community updates, or crisis mode reminders. You can always manage this later.</p>
                    <div class="flex items-center gap-4 mt-2">
                        <button class="permission-toggle-btn active-toggle bg-green text-white px-4 py-2 rounded-full font-semibold" data-permission-type="notifications" data-permission-status="allow">Allow</button>
                        <button class="permission-toggle-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-full font-semibold" data-permission-type="notifications" data-permission-status="deny">Limited Features</button>
                    </div>
                </div>

                <!-- Contacts Section -->
                <div class="permission-section w-full max-w-sm mb-6 text-left">
                    <h3 class="text-lg font-semibold text-text">Contacts</h3>
                    <p class="text-sm text-gray-500 mb-2">This allows you to automatically import selected contacts to designated your <strong>Trusted Contact(s)</strong>. If you decline, you can still manually add emergency contacts to use in crisis situations.</p>
                    <div class="flex items-center gap-4 mt-2">
                        <button class="permission-toggle-btn active-toggle bg-green text-white px-4 py-2 rounded-full font-semibold" data-permission-type="contacts" data-permission-status="allow">Allow</button>
                        <button class="permission-toggle-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-full font-semibold" data-permission-type="contacts" data-permission-status="deny">Limited Features</button>
                    </div>
                </div>

                <button id="continue-to-app-btn" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-primary text-white w-full max-w-sm mt-4">Continue to App</button>
                <p class="text-xs text-gray-400 mt-4 text-center">You can manage your permissions again in your account settings.</p>
            </div>
        </div>

        <!-- Main App Screen (Map) -->
        <div id="main-screen" class="screen flex-col items-center p-4 md:p-6">
            <div id="search-container" class="w-full max-w-xl flex gap-2">
                <div class="relative flex-1 shadow-md rounded-full overflow-hidden">
                    <input id="search-input" type="text" placeholder="Search for places..."
                        class="w-full pl-5 pr-12 py-3 rounded-full text-gray-900 bg-white border-transparent focus:outline-none focus:ring-2 focus:ring-primary">
                    <button id="search-btn" class="absolute right-0 top-0 h-full w-12 flex items-center justify-center text-primary">
                        <i class="fa-solid fa-search"></i>
                    </button>
                </div>
                <button id="filter-btn" class="flex items-center justify-center w-12 h-12 rounded-full bg-white shadow-md text-primary">
                    <i class="fa-solid fa-filter"></i>
                </button>
            </div>
            <div id="map-container" class="w-full max-w-3xl rounded-xl shadow-lg mt-4 h-80 md:h-96 overflow-hidden">
                <div id="map"></div>
            </div>
            <div class="flex flex-col sm:flex-row gap-4 mt-4 w-full max-w-xl">
                <button id="find-safe-space-btn" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-green text-white w-full">Find My Safe Space</button>
                <button id="crisis-mode-btn" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-red text-white w-full">Crisis Mode</button>
            </div>
            <button id="fab" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-primary text-white">
                <i class="fa-solid fa-plus text-2xl"></i>
            </button>
            <div id="anonymous-banner" class="fixed bottom-0 left-0 right-0 text-center py-2 bg-yellow-400 text-gray-800 text-sm font-medium hidden">
                You are in anonymous mode. Some features may be limited.
            </div>
        </div>

        <!-- Modals -->
        <div id="submit-modal" class="modal-overlay">
            <div class="modal-content w-11/12 max-w-xl p-6 md:p-8 rounded-xl bg-white shadow-xl">
                <h3 class="text-2xl font-bold mb-4 text-center">Submit a New Location</h3>
                <form id="submission-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1" for="place-name">Name of Place*</label>
                        <input type="text" id="place-name" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1" for="place-address">Address*</label>
                        <input type="text" id="place-address" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1" for="place-category">Category*</label>
                        <select id="place-category" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition">
                            <option value="">Select Category</option>
                            <option value="Bar/drinks">Bar/drinks</option>
                            <option value="Coffee">Coffee</option>
                            <option value="Dining">Dining</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Medical">Medical</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Religious Institution">Religious Institution</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Safety Rating*</label>
                        <div class="flex gap-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="safety-rating" value="Safe" required class="form-radio text-green-500">
                                <span class="ml-2">Safe</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="safety-rating" value="Mixed" class="form-radio text-yellow-500">
                                <span class="ml-2">Mixed</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="safety-rating" value="Not Safe" class="form-radio text-red-500">
                                <span class="ml-2">Not Safe</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Tags</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="tags" value="Gender neutral bathrooms" class="form-checkbox">
                                <span class="ml-1 text-sm">Gender neutral bathrooms</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="tags" value="Pet friendly" class="form-checkbox">
                                <span class="ml-1 text-sm">Pet friendly</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="tags" value="Queer staff" class="form-checkbox">
                                <span class="ml-1 text-sm">Queer staff</span>
                            </label>
                        </div>
                        <input type="text" id="custom-tags" placeholder="Add custom tags (comma-separated)" class="w-full p-2 mt-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1" for="felt-safe-as">Felt Safe Here as (Optional)</label>
                        <input type="text" id="felt-safe-as" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1" for="other-details">Other details</label>
                        <textarea id="other-details" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition"></textarea>
                    </div>
                    <button type="submit"
                        class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-primary text-white w-full">Submit
                        Location</button>
                    <button type="button"
                        class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-transparent text-primary border-2 border-primary w-full mt-2"
                        onclick="closeModal('submit-modal')">Cancel</button>
                </form>
            </div>
        </div>
        
        <div id="filter-modal" class="modal-overlay">
            <div class="modal-content text-center">
                <h3 class="text-2xl font-bold mb-4">Filter Locations</h3>
                <div id="filter-options" class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-6">
                    <label class="flex items-center space-x-2 p-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors">
                        <input type="checkbox" name="category-filter" value="Bar/drinks" class="form-checkbox text-primary rounded-md">
                        <span class="text-sm">Bar/drinks</span>
                    </label>
                    <label class="flex items-center space-x-2 p-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors">
                        <input type="checkbox" name="category-filter" value="Coffee" class="form-checkbox text-primary rounded-md">
                        <span class="text-sm">Coffee</span>
                    </label>
                    <label class="flex items-center space-x-2 p-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors">
                        <input type="checkbox" name="category-filter" value="Dining" class="form-checkbox text-primary rounded-md">
                        <span class="text-sm">Dining</span>
                    </label>
                    <label class="flex items-center space-x-2 p-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors">
                        <input type="checkbox" name="category-filter" value="Entertainment" class="form-checkbox text-primary rounded-md">
                        <span class="text-sm">Entertainment</span>
                    </label>
                    <label class="flex items-center space-x-2 p-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors">
                        <input type="checkbox" name="category-filter" value="Medical" class="form-checkbox text-primary rounded-md">
                        <span class="text-sm">Medical</span>
                    </label>
                    <label class="flex items-center space-x-2 p-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors">
                        <input type="checkbox" name="category-filter" value="Shopping" class="form-checkbox text-primary rounded-md">
                        <span class="text-sm">Shopping</span>
                    </label>
                    <label class="flex items-center space-x-2 p-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors">
                        <input type="checkbox" name="category-filter" value="Religious Institution" class="form-checkbox text-primary rounded-md">
                        <span class="text-sm">Religious Institution</span>
                    </label>
                </div>
                <button id="apply-filters-btn" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-primary text-white w-full">Apply Filters</button>
            </div>
        </div>

        <div id="login-modal" class="modal-overlay">
            <div class="modal-content text-center">
                <h3 class="text-2xl font-bold mb-4">Sign in</h3>
                <form id="login-form" class="space-y-4">
                    <div>
                        <input type="email" id="login-email" placeholder="Email" required
                            class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <input type="password" id="login-password" placeholder="Password" required
                            class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <button type="submit"
                        class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-primary text-white w-full">Sign
                        In</button>
                </form>
                <div class="mt-4 text-sm text-gray-500 flex justify-between items-center">
                    <button id="cancel-login" class="text-primary hover:underline"
                        onclick="closeModal('login-modal')">Cancel</button>
                    <button id="forgot-password" class="text-primary hover:underline">Forgot password?</button>
                </div>
            </div>
        </div>

        <div id="signup-modal" class="modal-overlay">
            <div class="modal-content text-center">
                <h3 class="text-2xl font-bold mb-4">Create Account</h3>
                <form id="signup-form" class="space-y-4">
                    <div>
                        <input type="email" id="signup-email" placeholder="Email" required
                            class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <input type="password" id="signup-password" placeholder="Password (min 6 characters)" required
                            class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <input type="password" id="signup-confirm-password" placeholder="Confirm Password" required
                            class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <button type="submit"
                        class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-signup text-white w-full">Sign
                        Up</button>
                    <button type="button"
                        class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-transparent text-primary border-2 border-primary w-full mt-2"
                        onclick="closeModal('signup-modal')">Cancel</button>
                </form>
            </div>
        </div>

        <div id="warning-modal" class="modal-overlay">
            <div class="modal-content text-center">
                <h3 class="text-xl font-bold mb-2">Limited Features</h3>
                <p>Please note with your selected privacy options, this site will have limited features.</p>
                <button class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-primary text-white mt-4">OK</button>
            </div>
        </div>
        
        <div id="coming-soon-modal" class="modal-overlay">
            <div class="modal-content text-center">
                <h3 class="text-xl font-bold mb-2">Feature Coming Soon!</h3>
                <p>Additional features are being developed to make this app even better. Stay tuned for more updates!</p>
                <button class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-primary text-white mt-4" onclick="closeModal('coming-soon-modal')">OK</button>
            </div>
        </div>

        <div id="no-safe-places-modal" class="modal-overlay">
            <div class="modal-content text-center">
                <h3 class="text-xl font-bold mb-2">No Safe Places Found</h3>
                <p>We could not find any safe locations nearby. Please stay aware of your surroundings.</p>
                <button class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-transparent text-primary border-2 border-primary mt-4"
                    onclick="closeModal('no-safe-places-modal')">OK</button>
            </div>
        </div>

        <div id="status-message-modal" class="modal-overlay">
            <div class="modal-content text-center">
                <h3 id="status-title" class="text-xl font-bold mb-2"></h3>
                <p id="status-message-text"></p>
                <button class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-transparent text-primary border-2 border-primary mt-4"
                    onclick="closeModal('status-message-modal')">OK</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = "https://sgvxsyvqluhivohypkkg.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNndnhzeXZxbHVoaXZvaHlwa2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3MjYzNzIsImV4cCI6MjA3MzMwMjM3Mn0.igseAZIczG6fEdtPNuF3_xyXb3rFKh5nQxxO_YUyCEs";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let map;
        let allLocations = [];
        let markers = [];
        let appState = {
            currentView: 'splash-screen',
            user: null,
            permissions: {
                location: true,
                notifications: true,
                contacts: true
            }
        };

        const views = {
            splash: document.getElementById('splash-screen'),
            permissions: document.getElementById('permissions-screen'),
            main: document.getElementById('main-screen')
        };

        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (session && session.user) {
                appState.user = session.user;
                if (appState.currentView === 'splash-screen' || appState.currentView === 'login-modal') {
                    showView('permissions');
                }
            } else {
                appState.user = null;
            }
        });

        function showView(viewName) {
            Object.keys(views).forEach(key => {
                views[key].classList.remove('active');
            });
            views[viewName].classList.add('active');
            appState.currentView = viewName;

            const anonBanner = document.getElementById('anonymous-banner');
            if (viewName === 'main' && !appState.user) {
                anonBanner.classList.remove('hidden');
            } else {
                anonBanner.classList.add('hidden');
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showMessage(title, message) {
            const modal = document.getElementById('status-message-modal');
            const modalTitle = document.getElementById('status-title');
            const messageText = document.getElementById('status-message-text');
            modalTitle.textContent = title;
            messageText.textContent = message;
            openModal('status-message-modal');
        }

        function createMarker(location) {
            const iconColor = {
                'Safe': 'green',
                'Mixed': 'yellow',
                'Not Safe': 'red',
                'Unknown': 'gray'
            };
            const marker = new google.maps.Marker({
                position: {
                    lat: location.latitude,
                    lng: location.longitude
                },
                map: map,
                icon: `http://maps.google.com/mapfiles/ms/icons/${iconColor[location.safety_rating]}-dot.png`,
                title: location.name,
                locationData: location
            });
            markers.push(marker);

            const infoWindowContent = `
                <div class="font-sans p-2">
                    <h4 class="font-bold text-lg">${location.name}</h4>
                    <p class="text-sm text-gray-700 mb-1">${location.address}</p>
                    <p class="text-sm font-semibold mb-1">Safety: <span class="font-normal">${location.safety_rating}</span></p>
                    <p class="text-sm font-semibold mb-1">Category: <span class="font-normal">${location.category}</span></p>
                    <p class="text-sm font-semibold">Tags: <span class="font-normal">${location.tags.join(', ') || 'N/A'}</span></p>
                    <p class="text-xs text-gray-500 mt-2">Added by: ${location.user_id ? 'Authenticated User' : 'Anonymous'}</p>
                </div>
            `;
            const infoWindow = new google.maps.InfoWindow({
                content: infoWindowContent
            });

            marker.addListener('click', () => {
                infoWindow.open({
                    anchor: marker,
                    map,
                    shouldFocus: false,
                });
            });
        }

        async function fetchLocations() {
            const {
                data,
                error
            } = await supabaseClient.from('locations').select('*');
            if (error) {
                console.error('Error fetching locations:', error);
                return;
            }
            allLocations = data;
            updateMarkers();
        }

        function updateMarkers(filteredLocations = allLocations) {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            filteredLocations.forEach(createMarker);
        }

        function filterLocations() {
            const selectedCategories = Array.from(document.querySelectorAll('input[name="category-filter"]:checked')).map(el => el.value);
            let filteredLocations = allLocations;

            if (selectedCategories.length > 0) {
                filteredLocations = allLocations.filter(location => selectedCategories.includes(location.category));
            }

            updateMarkers(filteredLocations);
        }

        function setupRealtimeListener() {
            supabaseClient.channel('public:locations')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'locations'
                }, (payload) => {
                    allLocations.push(payload.new);
                    filterLocations();
                })
                .subscribe();
        }

        function setupEventListeners() {
            document.getElementById('sign-in-btn').addEventListener('click', () => {
                openModal('login-modal');
            });

            document.getElementById('sign-up-btn').addEventListener('click', () => {
                openModal('signup-modal');
            });

            document.getElementById('anon-btn').addEventListener('click', async () => {
                const { data, error } = await supabaseClient.auth.signInAnonymously();
                if (error) {
                    showMessage('Error', 'Failed to sign in anonymously. Please try again.');
                    console.error('Anonymous sign in failed:', error);
                } else {
                    showView('permissions');
                }
            });

            document.querySelectorAll('.permission-toggle-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const permissionType = e.target.getAttribute('data-permission-type');
                    const permissionStatus = e.target.getAttribute('data-permission-status');
                    document.querySelectorAll(`.permission-toggle-btn[data-permission-type="${permissionType}"]`).forEach(btn => {
                        btn.classList.remove('active-toggle', 'bg-green', 'bg-red', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    e.target.classList.add('active-toggle');
                    e.target.classList.remove('bg-gray-200', 'text-gray-700');
                    e.target.classList.add(permissionStatus === 'allow' ? 'bg-green' : 'bg-red');
                    e.target.classList.add('text-white');
                    appState.permissions[permissionType] = (permissionStatus === 'allow');
                });
            });

            document.getElementById('continue-to-app-btn').addEventListener('click', () => {
                if (appState.permissions.location) {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(position => {
                            const userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            map.setCenter(userLocation);
                            map.setZoom(14);
                            showView('main');
                        }, error => {
                            console.error("Geolocation failed:", error);
                            showMessage('Error', 'Geolocation is required for this feature.');
                            showView('main');
                        });
                    } else {
                        showMessage('Error', 'Geolocation is not supported by your browser.');
                        showView('main');
                    }
                } else {
                    showView('main');
                    openModal('warning-modal');
                }
            });

            document.getElementById('fab').addEventListener('click', () => {
                openModal('submit-modal');
            });

            document.getElementById('filter-btn').addEventListener('click', () => {
                openModal('filter-modal');
            });
            
            document.getElementById('apply-filters-btn').addEventListener('click', () => {
                filterLocations();
                closeModal('filter-modal');
            });

            document.getElementById('find-safe-space-btn').addEventListener('click', () => {
                openModal('coming-soon-modal');
            });

            document.getElementById('crisis-mode-btn').addEventListener('click', () => {
                openModal('coming-soon-modal');
            });

            document.getElementById('submission-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('place-name').value;
                const address = document.getElementById('place-address').value;
                const category = document.getElementById('place-category').value;
                const safetyRating = document.querySelector('input[name="safety-rating"]:checked').value;
                const feltSafeAs = document.getElementById('felt-safe-as').value;
                const otherDetails = document.getElementById('other-details').value;
                
                const checkedTags = Array.from(document.querySelectorAll('input[name="tags"]:checked')).map(el => el.value);
                const customTags = document.getElementById('custom-tags').value.split(',').map(tag => tag.trim()).filter(tag => tag !== "");
                const allTags = [...new Set([...checkedTags, ...customTags])];

                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({
                    address
                }, async (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const lat = results[0].geometry.location.lat();
                        const lng = results[0].geometry.location.lng();

                        const {
                            error
                        } = await supabaseClient.from('locations').insert([{
                            name,
                            address,
                            latitude: lat,
                            longitude: lng,
                            category,
                            safety_rating: safetyRating,
                            tags: allTags,
                            felt_safe_as: feltSafeAs,
                            details: otherDetails,
                            user_id: appState.user ? appState.user.id : null
                        }]);

                        if (error) {
                            console.error('Error submitting location:', error);
                        } else {
                            console.log('Location submitted successfully!');
                            closeModal('submit-modal');
                            document.getElementById('submission-form').reset();
                        }
                    } else {
                        console.error('Geocode was not successful for the following reason:', status);
                        showMessage('Error', 'Could not find a valid location for the address provided.');
                    }
                });
            });

            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) {
                    showMessage('Error', 'Login failed: ' + error.message);
                    console.error('Login failed:', error);
                } else {
                    closeModal('login-modal');
                    showView('permissions');
                }
            });

            document.getElementById('signup-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const confirmPassword = document.getElementById('signup-confirm-password').value;
                
                if (password !== confirmPassword) {
                    showMessage('Error', 'Passwords do not match. Please try again.');
                    return;
                }
                
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password
                });
                
                if (error) {
                    showMessage('Error', 'Sign up failed: ' + error.message);
                    console.error('Sign up failed:', error);
                } else {
                    closeModal('signup-modal');
                    showMessage('Success', 'Check your email for a confirmation link to complete your sign-up.');
                }
            });
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: {
                    lat: 34.0522,
                    lng: -118.2437
                },
                zoom: 12,
                mapId: "DEMO_MAP_ID",
                streetViewControl: false,
                fullscreenControl: false,
            });

            const autocompleteInput = document.getElementById('search-input');
            const autocomplete = new google.maps.places.Autocomplete(autocompleteInput);
            autocomplete.bindTo('bounds', map);
            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (!place.geometry || !place.geometry.location) {
                    console.error("No geometry for the place.");
                    return;
                }
                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);
                }
            });
            fetchLocations();
            setupRealtimeListener();
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
        });
    </script>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD1CzCfikz8oJVPe50hrHLNz2VKnN4rjMc&libraries=places,geometry&callback=initMap">
    </script>
</body>

</html>
