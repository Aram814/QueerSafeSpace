<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QueerSafeSpace</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#94a3b8',
                        background: '#f1f5f9',
                        text: '#1e293b',
                        white: '#ffffff',
                        red: '#ef4444',
                        green: '#22c55e',
                        yellow: '#facc15',
                        signin: '#FF6161',
                        signup: '#80FD91',
                    }
                }
            }
        }
    </script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        xintegrity="sha512-iecdLp/Xq/C7xP5Kj8T6hE3p78+kC/K7p+g1k6Qf6d2G9w9a7a9g5tS5K3X/9z7aG6wD9wG8wF2e6y"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #94a3b8;
            --background: #f1f5f9;
            --text: #1e293b;
            --white: #ffffff;
            --red: #ef4444;
            --green: #22c55e;
            --yellow: #facc15;
        }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--text);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #app-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .screen {
            display: none;
            flex-grow: 1;
            overflow: auto;
            animation: fadeIn 0.5s ease-in-out;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--white);
            z-index: 10;
            transition: opacity 0.5s ease-in-out;
            opacity: 1;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        .rainbow-bg {
            background: linear-gradient(135deg, rgba(255, 105, 180, 0.3), rgba(255, 255, 0, 0.3), rgba(0, 255, 0, 0.3), rgba(0, 191, 255, 0.3), rgba(138, 43, 226, 0.3));
        }

        #map {
            flex-grow: 1;
            width: 100%;
            height: 100%;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--white);
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background-color: rgb(138, 63, 252);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 50;
            transition: transform 0.2s ease-in-out;
        }

        #fab:active {
            transform: scale(0.95);
        }

        #crisis-button {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            padding: 0.75rem 1.5rem;
            background-color: var(--red);
            color: var(--white);
            border-radius: 9999px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 50;
            transition: transform 0.2s ease-in-out;
            font-weight: 600;
        }

        #crisis-button:active {
            transform: scale(0.95);
        }

        #search-container {
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            width: 90%;
            max-width: 500px;
            display: flex;
            gap: 0.5rem;
        }

        .landing-logo {
            width: 200px;
            height: auto;
            margin-bottom: 2rem;
        }

        .location-illustration {
            width: 80%;
            max-width: 300px;
            height: auto;
            margin-bottom: 2rem;
        }
    </style>
</head>

<body>
    <div id="app-container">
        <!-- Splash Screen -->
        <div id="splash-screen" class="screen active p-8 rainbow-bg flex flex-col items-center justify-start pt-20">
            <img src="https://raw.githubusercontent.com/Aram814/QueerSafeSpace/refs/heads/main/IMG_9650.PNG" alt="QueerSafeSpace Logo"
                class="landing-logo">
            <h1 class="text-4xl md:text-5xl font-bold mt-4">QueerSafeSpace</h1>
            <p class="text-gray-500 text-lg mt-2">Because Safety Shouldnâ€™t Be A Privilege</p>
            <div class="mt-8 w-full max-w-sm flex flex-col gap-4">
                <button id="sign-in-btn" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-signin text-white w-full">Sign in</button>
                <button id="sign-up-btn" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-signup text-white w-full">Sign up</button>
                <button id="anon-btn" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-transparent text-primary border-2 border-primary w-full">Continue anonymously</button>
                <p class="text-sm text-gray-500 mt-2 text-center">The app is fully anonymous to protect all users. However, without an account, saved data is limited resulting in limited features.</p>
            </div>
        </div>

        <!-- Permissions Screen -->
        <div id="permissions-screen" class="screen justify-center items-center p-8 text-center rainbow-bg">
            <div class="flex flex-col items-center p-6 md:p-10 rounded-xl">
                <img src="https://placehold.co/300x300/e2e8f0/64748b?text=Location" alt="Location Illustration"
                    class="location-illustration">
                <h2 class="text-3xl font-bold mb-2">Location is everything.</h2>
                <p class="text-gray-500 mb-8 max-w-sm">Allowing location services is critical for us to show you nearby safe and unsafe spaces. We will never share your exact location.</p>
                <div class="mt-8 flex flex-col gap-4 w-full max-w-sm">
                    <button id="allow-location-btn" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-primary text-white w-full">Allow Location</button>
                    <button id="skip-location-btn" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-transparent text-primary border-2 border-primary w-full">Skip for now</button>
                </div>
            </div>
        </div>

        <!-- Main App Screen (Map) -->
        <div id="main-screen" class="screen flex-col">
            <div id="search-container">
                <div class="relative w-full shadow-md rounded-full overflow-hidden">
                    <input id="search-input" type="text" placeholder="Search for places..."
                        class="w-full pl-5 pr-12 py-3 rounded-full text-gray-900 bg-white border-transparent focus:outline-none focus:ring-2 focus:ring-primary">
                    <button id="search-btn" class="absolute right-0 top-0 h-full w-12 flex items-center justify-center text-primary">
                        <i class="fa-solid fa-search"></i>
                    </button>
                </div>
                <button id="filter-btn" class="flex items-center justify-center w-12 h-12 rounded-full bg-white shadow-md text-primary">
                    <i class="fa-solid fa-filter"></i>
                </button>
            </div>
            <div id="map"></div>
            <button id="fab" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-primary text-white">
                <i class="fa-solid fa-plus text-2xl"></i>
            </button>
            <button id="crisis-button">
                Crisis Mode
            </button>
            <div id="anonymous-banner" class="fixed bottom-0 left-0 right-0 text-center py-2 bg-yellow-400 text-gray-800 text-sm font-medium hidden">
                You are in anonymous mode. Some features may be limited.
            </div>
        </div>

        <!-- Modals -->
        <div id="submit-modal" class="modal-overlay">
            <div class="modal-content w-11/12 max-w-xl p-6 md:p-8 rounded-xl bg-white shadow-xl">
                <h3 class="text-2xl font-bold mb-4 text-center">Submit a New Location</h3>
                <form id="submission-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1" for="place-name">Name of Place*</label>
                        <input type="text" id="place-name" required class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1" for="place-address">Address*</label>
                        <input type="text" id="place-address" required class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1" for="place-category">Category*</label>
                        <select id="place-category" required class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">Select Category</option>
                            <option value="Bar/drinks">Bar/drinks</option>
                            <option value="Coffee">Coffee</option>
                            <option value="Dining">Dining</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Medical">Medical</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Religious Institution">Religious Institution</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Safety Rating*</label>
                        <div class="flex gap-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="safety-rating" value="Safe" required class="form-radio text-green-500">
                                <span class="ml-2">Safe</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="safety-rating" value="Mixed" class="form-radio text-yellow-500">
                                <span class="ml-2">Mixed</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="safety-rating" value="Not Safe" class="form-radio text-red-500">
                                <span class="ml-2">Not Safe</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Tags</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="tags" value="Gender neutral bathrooms" class="form-checkbox">
                                <span class="ml-1 text-sm">Gender neutral bathrooms</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="tags" value="Pet friendly" class="form-checkbox">
                                <span class="ml-1 text-sm">Pet friendly</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="tags" value="Queer staff" class="form-checkbox">
                                <span class="ml-1 text-sm">Queer staff</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1" for="felt-safe-as">Felt Safe Here as</label>
                        <input type="text" id="felt-safe-as" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1" for="other-details">Other details</label>
                        <textarea id="other-details" rows="3" class="w-full p-2 border border-gray-300 rounded-lg"></textarea>
                    </div>
                    <button type="submit" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-primary text-white w-full">Submit Location</button>
                    <button type="button" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-transparent text-primary border-2 border-primary w-full mt-2" onclick="closeModal('submit-modal')">Cancel</button>
                </form>
            </div>
        </div>

        <div id="login-modal" class="modal-overlay">
            <div class="modal-content text-center">
                <h3 class="text-2xl font-bold mb-4">Sign in</h3>
                <form id="login-form" class="space-y-4">
                    <div>
                        <input type="email" id="login-email" placeholder="Email" required class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <input type="password" id="login-password" placeholder="Password" required class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <button type="submit" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-primary text-white w-full">Sign In</button>
                </form>
                <div class="mt-4 text-sm text-gray-500 flex justify-between items-center">
                    <button id="cancel-login" class="text-primary hover:underline" onclick="closeModal('login-modal')">Cancel</button>
                    <button id="forgot-password" class="text-primary hover:underline">Forgot password?</button>
                </div>
            </div>
        </div>

        <div id="signup-modal" class="modal-overlay">
            <div class="modal-content text-center">
                <h3 class="text-2xl font-bold mb-4">Create Account</h3>
                <form id="signup-form" class="space-y-4">
                    <div>
                        <input type="email" id="signup-email" placeholder="Email" required class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <input type="password" id="signup-password" placeholder="Password (min 6 characters)" required class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <input type="password" id="signup-confirm-password" placeholder="Confirm Password" required class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <button type="submit" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-signup text-white w-full">Sign Up</button>
                    <button type="button" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-transparent text-primary border-2 border-primary w-full mt-2" onclick="closeModal('signup-modal')">Cancel</button>
                </form>
            </div>
        </div>

        <div id="warning-modal" class="modal-overlay">
            <div class="modal-content text-center">
                <h3 class="text-xl font-bold mb-2">Limited Features</h3>
                <p>Please note with your selected privacy options, this site will have limited features.</p>
                <button class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-primary text-white mt-4">OK</button>
            </div>
        </div>

        <div id="crisis-modal" class="modal-overlay">
            <div class="modal-content text-center">
                <h3 class="text-xl font-bold mb-2">Crisis Mode Activated</h3>
                <p>Finding the nearest safe location. Please stay calm.</p>
                <button class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-primary text-white mt-4" onclick="closeModal('crisis-modal')">Dismiss</button>
            </div>
        </div>

        <div id="filter-modal" class="modal-overlay">
            <div class="modal-content w-11/12 max-w-xl p-6 md:p-8 rounded-xl bg-white shadow-xl">
                <h3 class="text-2xl font-bold mb-4 text-center">Filter Locations</h3>
                <form id="filter-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Category</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="filter-category" value="Bar/drinks" class="form-checkbox">
                                <span class="ml-1 text-sm">Bar/drinks</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="filter-category" value="Coffee" class="form-checkbox">
                                <span class="ml-1 text-sm">Coffee</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="filter-category" value="Dining" class="form-checkbox">
                                <span class="ml-1 text-sm">Dining</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="filter-category" value="Entertainment" class="form-checkbox">
                                <span class="ml-1 text-sm">Entertainment</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="filter-category" value="Medical" class="form-checkbox">
                                <span class="ml-1 text-sm">Medical</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="filter-category" value="Shopping" class="form-checkbox">
                                <span class="ml-1 text-sm">Shopping</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="filter-category" value="Religious Institution" class="form-checkbox">
                                <span class="ml-1 text-sm">Religious Institution</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Safety Rating</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="filter-safety" value="Safe" class="form-checkbox">
                                <span class="ml-1 text-sm">Safe</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="filter-safety" value="Mixed" class="form-checkbox">
                                <span class="ml-1 text-sm">Mixed</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="filter-safety" value="Not Safe" class="form-checkbox">
                                <span class="ml-1 text-sm">Not Safe</span>
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-primary text-white w-full">Apply Filters</button>
                    <button type="button" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-transparent text-primary border-2 border-primary w-full mt-2" onclick="closeModal('filter-modal')">Cancel</button>
                </form>
            </div>
        </div>

        <div id="info-modal" class="modal-overlay">
            <div class="modal-content w-11/12 max-w-xl p-6 md:p-8 rounded-xl bg-white shadow-xl">
                <div id="info-content"></div>
                <button class="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-primary text-white mt-4" onclick="closeModal('info-modal')">Close</button>
            </div>
        </div>
        
    </div>

    <!-- Firebase -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Supabase configuration
        const SUPABASE_URL = 'https://sgvxsyvqluhivohypkkg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNndnhzeXZxbHVoaXZvaHlwa2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3MjYzNzIsImV4cCI6MjA3MzMwMjM3Mn0.igseAZIczG6fEdtPNuF3_xyXb3rFKh5nQxxO_YUyCEs';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Google Maps API
        const GOOGLE_MAPS_API_KEY = 'AIzaSyD1CzCfikz8oJVPe50hrHLNz2VKnN4rjMc';

        // Global variables for map and markers
        let map;
        let markers = [];
        let userMarker;
        let infoWindow;
        let geocoder;

        const splashScreen = document.getElementById('splash-screen');
        const permissionsScreen = document.getElementById('permissions-screen');
        const mainScreen = document.getElementById('main-screen');
        const loginModal = document.getElementById('login-modal');
        const signupModal = document.getElementById('signup-modal');
        const submitModal = document.getElementById('submit-modal');
        const filterModal = document.getElementById('filter-modal');
        const infoModal = document.getElementById('info-modal');

        const signInBtn = document.getElementById('sign-in-btn');
        const signUpBtn = document.getElementById('sign-up-btn');
        const anonBtn = document.getElementById('anon-btn');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');

        const fab = document.getElementById('fab');
        const submitForm = document.getElementById('submission-form');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const filterBtn = document.getElementById('filter-btn');
        const crisisModeBtn = document.getElementById('crisis-mode-btn');

        const allowLocationBtn = document.getElementById('allow-location-btn');
        const skipLocationBtn = document.getElementById('skip-location-btn');

        const anonymousBanner = document.getElementById('anonymous-banner');

        function showScreen(screen) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(s => s.classList.remove('active'));
            screen.classList.add('active');
        }

        function showModal(modal) {
            modal.style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Handle splash screen button clicks
        signInBtn.addEventListener('click', () => showModal(loginModal));
        signUpBtn.addEventListener('click', () => showModal(signupModal));
        anonBtn.addEventListener('click', () => {
            showScreen(permissionsScreen);
            anonymousBanner.classList.remove('hidden');
        });

        // Handle user authentication
        supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                console.log('User logged in:', session.user);
                showScreen(permissionsScreen);
                checkUserFeatures(session.user);
            } else {
                console.log('User logged out or not authenticated');
                showScreen(splashScreen);
            }
        });

        async function handleLogin(e) {
            e.preventDefault();
            const email = e.target['login-email'].value;
            const password = e.target['login-password'].value;
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                showMessage(`Error: ${error.message}`, 'error');
            } else {
                showMessage('Signed in successfully!', 'success');
                closeModal('login-modal');
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            const email = e.target['signup-email'].value;
            const password = e.target['signup-password'].value;
            const confirmPassword = e.target['signup-confirm-password'].value;

            if (password !== confirmPassword) {
                showMessage('Error: Passwords do not match.', 'error');
                return;
            }

            const { data, error } = await supabase.auth.signUp({ email, password });
            if (error) {
                showMessage(`Error: ${error.message}`, 'error');
            } else {
                showMessage('Success! Check your email for a confirmation link to complete your sign-up.', 'success');
                closeModal('signup-modal');
            }
        }

        loginForm.addEventListener('submit', handleLogin);
        signupForm.addEventListener('submit', handleSignup);

        // Handle location permissions
        allowLocationBtn.addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    initMap(pos);
                    showScreen(mainScreen);
                }, () => {
                    initMap(); // Fallback to default map view
                    showMessage('Permission denied. Limited features available.', 'warning');
                    showScreen(mainScreen);
                });
            } else {
                initMap(); // Fallback to default map view
                showMessage('Geolocation is not supported by your browser.', 'warning');
                showScreen(mainScreen);
            }
        });

        skipLocationBtn.addEventListener('click', () => {
            initMap();
            showMessage('Skipped location. Limited features available.', 'warning');
            showScreen(mainScreen);
        });

        function showMessage(message, type) {
            const modal = document.getElementById('warning-modal');
            const content = modal.querySelector('p');
            content.textContent = message;
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 5000);
        }

        // Map initialization and functionality
        window.initMap = async function () {
            // Default location
            const defaultPos = { lat: 39.8283, lng: -98.5795 };
            const { Map } = await google.maps.importLibrary("maps");
            const { Geocoder } = await google.maps.importLibrary("geocoding");
            
            map = new Map(document.getElementById('map'), {
                zoom: 4,
                center: defaultPos,
                mapId: 'DEMO_MAP_ID',
                disableDefaultUI: true,
            });

            geocoder = new Geocoder();

            fetchLocations();
            setupRealtimeListener();

            // Handle map clicks to close info window
            map.addListener('click', () => {
                if (infoWindow) {
                    infoWindow.close();
                }
            });
        };

        function fetchLocations() {
            supabase.from('locations')
                .select('*')
                .then(response => {
                    if (response.error) throw response.error;
                    clearMarkers();
                    response.data.forEach(location => addMarker(location));
                })
                .catch(error => console.error('Error fetching locations:', error.message));
        }

        function setupRealtimeListener() {
            supabase.channel('public:locations')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'locations' }, payload => {
                    console.log('New location added:', payload.new);
                    addMarker(payload.new);
                })
                .subscribe();
        }

        function addMarker(location) {
            const latLng = { lat: location.latitude, lng: location.longitude };
            const marker = new google.maps.Marker({
                position: latLng,
                map: map,
                icon: getMarkerIcon(location.safety_rating)
            });

            marker.addListener('click', () => {
                if (infoWindow) infoWindow.close();
                const content = `
                <div class="p-2 font-inter max-w-sm">
                    <h4 class="font-bold text-lg mb-1">${location.name}</h4>
                    <p class="text-sm text-gray-600 mb-2">${location.address}</p>
                    <p class="text-xs font-semibold">Category: <span class="font-normal">${location.category}</span></p>
                    <p class="text-xs font-semibold">Safety: <span class="font-normal">${location.safety_rating}</span></p>
                    <p class="text-xs font-semibold">Details: <span class="font-normal">${location.details || 'No details provided.'}</span></p>
                </div>
                `;
                infoWindow = new google.maps.InfoWindow({ content: content });
                infoWindow.open(map, marker);
            });
            markers.push(marker);
        }

        function getMarkerIcon(rating) {
            let color;
            switch (rating) {
                case 'Safe':
                    color = 'green';
                    break;
                case 'Mixed':
                    color = 'yellow';
                    break;
                case 'Not Safe':
                    color = 'red';
                    break;
                default:
                    color = 'blue';
            }
            return `http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`;
        }

        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
        }

        // Form submission for new locations
        fab.addEventListener('click', () => showModal(submitModal));

        submitForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const address = e.target['place-address'].value;
            geocoder.geocode({ 'address': address }, async (results, status) => {
                if (status === 'OK') {
                    const lat = results[0].geometry.location.lat();
                    const lng = results[0].geometry.location.lng();

                    const newLocation = {
                        name: e.target['place-name'].value,
                        address: address,
                        latitude: lat,
                        longitude: lng,
                        category: e.target['place-category'].value,
                        safety_rating: e.target['safety-rating'].value,
                        tags: Array.from(e.target.querySelectorAll('input[name="tags"]:checked')).map(el => el.value),
                        felt_safe_as: e.target['felt-safe-as'].value,
                        details: e.target['other-details'].value,
                    };

                    const { data, error } = await supabase.from('locations').insert([newLocation]);
                    if (error) {
                        showMessage(`Error submitting location: ${error.message}`, 'error');
                    } else {
                        showMessage('Location submitted successfully!', 'success');
                        closeModal('submit-modal');
                    }
                } else {
                    showMessage('Geocode was not successful for the following reason: ' + status, 'error');
                }
            });
        });

        // Search and Filter functionality
        let currentFilter = { category: [], safety: [] };

        searchBtn.addEventListener('click', async () => {
            const query = searchInput.value;
            if (query) {
                const { data, error } = await supabase
                    .from('locations')
                    .select('*')
                    .ilike('name', `%${query}%`);

                if (error) {
                    console.error('Error searching:', error.message);
                } else {
                    clearMarkers();
                    data.forEach(location => addMarker(location));
                }
            } else {
                fetchLocations();
            }
        });

        filterBtn.addEventListener('click', () => showModal(filterModal));

        document.getElementById('filter-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const selectedCategories = Array.from(e.target.querySelectorAll('input[name="filter-category"]:checked')).map(el => el.value);
            const selectedSafety = Array.from(e.target.querySelectorAll('input[name="filter-safety"]:checked')).map(el => el.value);

            let query = supabase.from('locations').select('*');

            if (selectedCategories.length > 0) {
                query = query.in('category', selectedCategories);
            }
            if (selectedSafety.length > 0) {
                query = query.in('safety_rating', selectedSafety);
            }

            const { data, error } = await query;
            if (error) {
                console.error('Error filtering:', error.message);
            } else {
                clearMarkers();
                data.forEach(location => addMarker(location));
            }
            closeModal('filter-modal');
        });

    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places,geometry&callback=initMap">
    </script>
</body>

</html>
