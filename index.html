<!DOCTYPE-html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QueerSafeSpace</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#94a3b8',
                        background: '#f1f5f9',
                        text: '#1e293b',
                        white: '#ffffff',
                        red: '#ef4444',
                        green: '#22c5e',
                        yellow: '#facc15',
                        signin: '#8F7FFF',
                        signup: '#8EFD17',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #94a3b8;
            --background: #f1f5f9;
            --text: #1e293b;
            --white: #ffffff;
            --red: #ef4444;
            --green: #22c5e;
            --yellow: #facc15;
            --find-space-blue: #1272EF;
        }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--text);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            background: linear-gradient(to right, rgba(255, 0, 0, 0.55), rgba(255, 144, 7, 0.55), rgba(251, 255, 0, 0.55), rgba(0, 250, 0, 0.55), rgba(0, 255, 238, 0.55), rgba(21, 0, 255, 0.55), rgba(106, 0, 255, 0.55), rgba(255, 0, 183, 0.55));
        }

        .screen {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            min-height: 100vh;
            overflow-y: auto;
            animation: fadeIn 0.5s ease-in-out;
            z-index: 10;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }
        
        #map { width: 100%; height: 100%; z-index: 1; }

        .content-card {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            z-index: 2;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        #fab {
            position: absolute;
            bottom: 2rem;
            left: 2rem;
            width: 60px;
            height: 60px;
            background-color: rgb(138, 63, 252);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 500;
        }

        #hamburger-menu-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 1000;
            background: white;
            padding: 0.75rem;
            border-radius: 9999px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #search-container {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            width: 280px;
        }

        #side-menu {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 2000;
        }

        #side-menu.open { transform: translateX(0); }

        .menu-content {
            width: 75%;
            max-width: 300px;
            height: 100%;
            background: white;
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }

        #map-container { flex-grow: 1; position: relative; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>

<body>
    <div id="app-container">
        <!-- Splash Screen -->
        <div id="splash-screen" class="screen active p-8 flex flex-col items-center justify-start pt-20">
            <div class="content-card w-full max-w-xl flex flex-col items-center text-center">
                <img src="https://raw.githubusercontent.com/Aram814/QueerSafeSpace/refs/heads/main/IMG_9650.PNG" alt="Logo" class="w-32 mb-4">
                <h1 class="text-3xl font-bold">QueerSafeSpace</h1>
                <p class="text-gray-500 mt-2">Safety Shouldn‚Äôt Be A Privilege</p>
                <div class="mt-8 w-full flex flex-col gap-4">
                    <button id="sign-in-btn" class="px-6 py-3 rounded-full font-semibold bg-signin text-white transition-transform active:scale-95">Sign in</button>
                    <button id="sign-up-btn" class="px-6 py-3 rounded-full font-semibold bg-signup text-white transition-transform active:scale-95">Sign up</button>
                </div>
            </div>
        </div>

        <!-- Main App Screen (Map) -->
        <div id="main-screen" class="screen flex-col">
            <div class="z-50 bg-white/80 backdrop-blur-md p-4 flex flex-col items-center border-b shadow-sm">
                <button id="hamburger-menu-btn" class="text-primary text-xl hover:bg-gray-100"><i class="fa-solid fa-bars"></i></button>
                <div class="flex items-center mb-2">
                    <img src="https://raw.githubusercontent.com/Aram814/QueerSafeSpace/refs/heads/main/IMG_9650.PNG" alt="Logo" class="h-8 w-8 mr-2">
                    <h1 class="text-xl font-bold">QueerSafeSpace</h1>
                </div>
            </div>

            <div id="map-container">
                <div id="map"></div>
                
                <!-- Search Bar -->
                <div id="search-container">
                    <div class="bg-white rounded-full shadow-lg p-1 pr-4 flex items-center border border-gray-100">
                        <input type="text" id="map-search-input" placeholder="Search a location..." class="bg-transparent border-none outline-none px-4 py-2 w-full text-sm">
                        <button id="map-search-btn" class="text-gray-400 hover:text-primary transition-colors">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </button>
                    </div>
                </div>

                <button id="fab" title="Register a location"><i class="fa-solid fa-plus text-2xl"></i></button>
            </div>

            <div class="bg-white/80 p-4 border-t">
                <div class="flex justify-center gap-4 text-xs mb-4 font-medium">
                    <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-green-500"></div>Safe</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-yellow-400"></div>Mixed</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-red-500"></div>Not Safe</div>
                </div>
                <div class="flex justify-between gap-2">
                    <button id="find-safe-space-btn" class="flex-1 bg-blue-600 text-white py-3 rounded-full font-bold shadow-md hover:bg-blue-700 transition-colors">Find My Safe Space</button>
                    <button id="crisis-button" class="px-6 bg-red-600 text-white py-3 rounded-full font-bold shadow-md hover:bg-red-700 transition-colors">Crisis</button>
                </div>
            </div>
        </div>

        <!-- Add Space Modal -->
        <div id="add-space-modal" class="modal-overlay">
            <div class="modal-content shadow-2xl">
                <h2 class="text-2xl font-bold mb-4 text-primary">Register a Safe Space</h2>
                <form id="add-space-form" class="space-y-4">
                    <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                        <label class="block text-[10px] uppercase tracking-wider text-indigo-400 font-bold mb-1">Found Location</label>
                        <p id="selected-address-text" class="text-sm text-indigo-900 font-medium"></p>
                    </div>
                    
                    <input type="hidden" id="new-lat">
                    <input type="hidden" id="new-lng">
                    <input type="hidden" id="new-address">
                    
                    <div>
                        <label class="block text-sm font-semibold mb-1">Place Name</label>
                        <input type="text" id="space-name" class="w-full border rounded-md p-2 focus:ring-2 focus:ring-primary outline-none" placeholder="e.g. Center City Library" required>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1">Category</label>
                            <select id="space-category" class="w-full border rounded-md p-2 focus:ring-2 focus:ring-primary outline-none">
                                <option value="Retail">Retail</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Community">Community Center</option>
                                <option value="Education">Education</option>
                                <option value="Dining">Dining/Bar</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">Safety Rating</label>
                            <select id="safety-rating" class="w-full border rounded-md p-2 focus:ring-2 focus:ring-primary outline-none">
                                <option value="Safe">Safe</option>
                                <option value="Mixed">Mixed</option>
                                <option value="Unsafe">Not Safe</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-1">Target Identity (Optional)</label>
                        <input type="text" id="space-identity" class="w-full border rounded-md p-2 focus:ring-2 focus:ring-primary outline-none" placeholder="e.g. Trans-inclusive, POC focus">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-1">Notes / Details</label>
                        <textarea id="space-notes" class="w-full border rounded-md p-2 h-20 focus:ring-2 focus:ring-primary outline-none" placeholder="Describe why this space is safe or mixed..." required></textarea>
                    </div>

                    <button type="submit" id="save-location-btn" class="w-full bg-primary text-white py-3 rounded-md font-bold shadow-lg hover:bg-indigo-700 transition-all active:scale-95">Save to Map</button>
                    <button type="button" onclick="hideModal('add-space-modal')" class="w-full text-gray-400 text-sm mt-2 hover:text-gray-600 transition-colors">Cancel</button>
                </form>
            </div>
        </div>

        <!-- Auth Modal -->
        <div id="auth-modal" class="modal-overlay">
            <div class="modal-content">
                <h2 id="auth-title" class="text-2xl font-bold mb-4">Welcome Back</h2>
                <form id="auth-form" class="space-y-4">
                    <input type="email" id="auth-email" placeholder="Email" class="w-full border rounded p-2 focus:ring-2 focus:ring-primary" required>
                    <input type="password" id="auth-password" placeholder="Password" class="w-full border rounded p-2 focus:ring-2 focus:ring-primary" required>
                    <button type="submit" id="auth-submit" class="w-full bg-primary text-white py-3 rounded-lg font-bold">Continue</button>
                </form>
                <button onclick="hideModal('auth-modal')" class="mt-4 w-full text-gray-400 text-sm text-center">Cancel</button>
            </div>
        </div>

        <!-- Sidebar Menu -->
        <div id="side-menu">
            <div class="menu-content shadow-2xl">
                <button id="close-menu-btn" class="self-end text-3xl text-gray-300 hover:text-primary transition-colors">&times;</button>
                <div class="flex items-center space-x-2 mb-8 border-b pb-4 mt-4">
                    <span id="menu-avatar" class="text-4xl">üè≥Ô∏è‚Äçüåà</span>
                    <div class="overflow-hidden">
                        <h3 id="user-name-display" class="text-xl font-bold truncate">Guest User</h3>
                        <p class="text-xs text-gray-400 uppercase tracking-widest font-bold">Community Member</p>
                    </div>
                </div>
                <nav class="flex flex-col gap-4">
                    <a href="#" class="font-semibold text-gray-700 hover:text-primary transition-colors"><i class="fa-solid fa-user mr-2 text-primary"></i> Account Settings</a>
                    <a href="#" class="font-semibold text-gray-700 hover:text-primary transition-colors"><i class="fa-solid fa-lock mr-2 text-primary"></i> Privacy Controls</a>
                    <a href="#" class="font-semibold text-gray-700 hover:text-primary transition-colors"><i class="fa-solid fa-heart mr-2 text-primary"></i> Saved Places</a>
                    <hr class="border-gray-100 my-4">
                    <button id="sign-out-btn" class="text-left font-semibold text-red-500 hover:opacity-80 transition-opacity"><i class="fa-solid fa-sign-out mr-2"></i> Log out</button>
                </nav>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Supabase Implementation -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.2/+esm';

        const supabaseUrl = 'https://sgvxsyvqluhivohypkkg.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNndnhzeXZxbHVoaXZvaHlwa2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3MjYzNzIsImV4cCI6MjA3MzMwMjM3Mn0.igseAZIczG6fEdtPNuF3_xyXb3rFKh5nQxxO_YUyCEs';
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        let map;
        const markers = {};
        const apiKey = ""; // Gemini API Key handled by environment

        window.showScreen = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'main-screen') {
                setTimeout(() => {
                    if(!map) initLeafletMap();
                    else map.invalidateSize();
                }, 100);
            }
        };

        window.showModal = (id) => document.getElementById(id).style.display = 'flex';
        window.hideModal = (id) => document.getElementById(id).style.display = 'none';

        function initLeafletMap() {
            if (map) return;
            map = L.map('map', { zoomControl: false }).setView([28.74, -82.49], 10);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
            loadLocations();
            supabase.channel('locations-realtime').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'locations' }, (payload) => addMarkerToMap(payload.new)).subscribe();
            map.locate({setView: true, maxZoom: 14});
            setupSearch();
        }

        async function setupSearch() {
            const searchInput = document.getElementById('map-search-input');
            const searchBtn = document.getElementById('map-search-btn');

            const performSearch = async () => {
                const query = searchInput.value.trim();
                if (!query) return;
                searchBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
                
                try {
                    // CORS Failover: If fetch fails, we use Gemini to get coordinates
                    // This bypasses the browser's restriction on direct Nominatim calls if the user's environment blocks it
                    const geminiGeocode = async (locQuery) => {
                        const systemPrompt = "You are a geocoding service. Return ONLY a JSON object with 'lat', 'lng', and 'display_name' for the requested location. No markdown, no extra text.";
                        const userPrompt = `Geocode this location: ${locQuery}`;
                        
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: userPrompt }] }],
                                systemInstruction: { parts: [{ text: systemPrompt }] },
                                generationConfig: { responseMimeType: "application/json" }
                            })
                        });
                        
                        if (!response.ok) throw new Error("Gemini Geocoding failed");
                        const result = await response.json();
                        return JSON.parse(result.candidates?.[0]?.content?.parts?.[0]?.text || "{}");
                    };

                    let result;
                    try {
                        // Attempt standard fetch first (for speed/accuracy)
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`, {
                            headers: { 'User-Agent': 'QueerSafeSpace-App' }
                        });
                        const data = await res.json();
                        if (data && data.length > 0) {
                            result = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon), display_name: data[0].display_name };
                        }
                    } catch (e) {
                        console.warn("Direct geocoding blocked by CORS, falling back to Gemini API...");
                        result = await geminiGeocode(query);
                    }

                    if (result && result.lat) {
                        map.setView([result.lat, result.lng], 16);
                        document.getElementById('new-lat').value = result.lat;
                        document.getElementById('new-lng').value = result.lng;
                        document.getElementById('new-address').value = result.display_name;
                        document.getElementById('selected-address-text').innerText = result.display_name;
                        
                        setTimeout(() => {
                            if (confirm(`Location found: ${result.display_name}\n\nWould you like to register this place as a safe space?`)) {
                                showModal('add-space-modal');
                            }
                        }, 500);
                    } else {
                        alert("No results found. Try adding a city name.");
                    }
                } catch (err) {
                    console.error("Geocoding Error:", err);
                    alert("Search failed due to network restrictions. Please try searching for a major city or checking your connection.");
                } finally {
                    searchBtn.innerHTML = '<i class="fa-solid fa-magnifying-glass"></i>';
                }
            };

            searchBtn.onclick = performSearch;
            searchInput.onkeypress = (e) => { if (e.key === 'Enter') performSearch(); };
        }

        async function loadLocations() {
            const { data, error } = await supabase.from('locations').select('*');
            if (data) data.forEach(addMarkerToMap);
            if (error) console.error("Error loading locations:", error);
        }

        function addMarkerToMap(loc) {
            if (markers[loc.id]) return;
            const colorMap = { 'Safe': '#22c55e', 'Mixed': '#facc15', 'Unsafe': '#ef4444' };
            const markerColor = colorMap[loc.safety_rating] || '#94a3b8';
            const markerIcon = L.divIcon({
                className: 'custom-pin',
                html: `<div style="background-color:${markerColor}; width:20px; height:20px; border-radius:50%; border:3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            const popupContent = `<div class="text-indigo-900 min-w-[160px] p-1 font-sans"><h3 class="font-bold text-base leading-tight">${loc.name || 'Unnamed Place'}</h3><div class="flex items-center gap-2 mt-1.5"><span class="text-[9px] font-bold text-white px-2 py-0.5 rounded-full" style="background:${markerColor}">${loc.safety_rating || 'Unknown'}</span><span class="text-[9px] font-bold text-indigo-300 uppercase tracking-tighter">${loc.category || 'Other'}</span></div>${loc.identity ? `<p class="text-[11px] font-bold text-indigo-500 mt-2"><i class="fa-solid fa-users mr-1"></i>${loc.identity}</p>` : ''}<p class="text-sm mt-2 text-gray-700 leading-snug italic border-l-2 border-indigo-50 pl-2">${loc.notes || 'No details provided.'}</p><hr class="my-2 border-gray-100"><p class="text-[9px] text-gray-400 font-medium leading-tight">${loc.address || 'Address not listed'}</p></div>`;
            const marker = L.marker([loc.latitude, loc.longitude], {icon: markerIcon}).addTo(map).bindPopup(popupContent);
            markers[loc.id] = marker;
        }

        document.getElementById('add-space-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('save-location-btn');
            btn.innerText = "Saving Location...";
            btn.disabled = true;
            const { data: { user } } = await supabase.auth.getUser();
            const newLocation = {
                name: document.getElementById('space-name').value,
                address: document.getElementById('new-address').value,
                category: document.getElementById('space-category').value,
                safety_rating: document.getElementById('safety-rating').value,
                notes: document.getElementById('space-notes').value,
                identity: document.getElementById('space-identity').value || null,
                latitude: parseFloat(document.getElementById('new-lat').value),
                longitude: parseFloat(document.getElementById('new-lng').value),
                user_id: user?.id || null,
                tags: '[]'
            };
            const { error } = await supabase.from('locations').insert([newLocation]);
            if (!error) { hideModal('add-space-modal'); document.getElementById('add-space-form').reset(); } else { alert("Database Error: " + error.message); }
            btn.innerText = "Save to Map"; btn.disabled = false;
        });

        document.getElementById('sign-in-btn').onclick = () => showModal('auth-modal');
        document.getElementById('sign-up-btn').onclick = () => showModal('auth-modal');
        document.getElementById('hamburger-menu-btn').onclick = () => document.getElementById('side-menu').classList.add('open');
        document.getElementById('close-menu-btn').onclick = () => document.getElementById('side-menu').classList.remove('open');
        document.getElementById('fab').onclick = () => alert("Use the search bar in the top right to locate a shop or center, then confirm to register it.");
        document.getElementById('sign-out-btn').onclick = async () => { await supabase.auth.signOut(); location.reload(); };
        document.getElementById('auth-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) { const { error: sError } = await supabase.auth.signUp({ email, password }); if (sError) alert(sError.message); }
            hideModal('auth-modal');
        };

        supabase.auth.onAuthStateChange((event, session) => {
            if (session) { document.getElementById('user-name-display').innerText = session.user.email.split('@')[0]; window.showScreen('main-screen'); }
            else window.showScreen('splash-screen');
        });

        (async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) { document.getElementById('user-name-display').innerText = session.user.email.split('@')[0]; window.showScreen('main-screen'); }
        })();
    </script>
</body>
</html>
